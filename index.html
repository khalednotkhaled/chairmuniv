<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ChairLink - The Best MUN Chair Assistant</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- Google Sign-In - Using Google Platform Library for better compatibility -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/platform.js" async defer></script>
<style>
    /* Theme-specific overrides */
    /* ChairLink Inky (Black and Navy) */
    .theme-inky {
      --bg-primary: #60609e;
      --bg-secondary: #1a1a2e;
      --text-primary: #e2e8f0;
      --text-secondary: #a0aec0;
      --accent: #3b82f6;
      --accent-light: #60a5fa;
    }

    /* Security Council (#495445 and #baba9b) */
    .theme-security {
      --bg-primary: #3a4a36;
      --bg-secondary: #495445;
      --text-primary: #f8fafc;
      --text-secondary: #e2e8f0;
      --accent: #baba9b;
      --accent-light: #d1d5db;
    }

    /* Crisis (Dark Red and Black) */
    .theme-crisis {
      --bg-primary: #1a0000; /* Darker black */
      --bg-secondary: #2c0000; /* Dark red */
      --text-primary: #f8dcdc; /* Light red for text */
      --text-secondary: #f3a5a5; /* Slightly darker light red */
      --accent: #e50000; /* Bright red accent */
      --accent-light: #ff3333; /* Lighter red accent */
    }

    /* Fancy (Gold and Black) */
    .theme-fancy {
      --bg-primary: #000000; /* Black */
      --bg-secondary: #1a1a1a; /* Dark gray for secondary */
      --text-primary: #ffeb3b; /* Gold text */
      --text-secondary: #ffe082; /* Lighter gold text */
      --accent: #ffd700; /* Gold accent */
      --accent-light: #ffeb8f; /* Lighter gold accent */
    }

    /* Apply theme colors */
    .theme-inky {
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    .theme-inky .bg-primary {
      background-color: var(--bg-primary);
    }

    .theme-inky .bg-secondary {
      background-color: var(--bg-secondary);
    }

    .theme-inky .text-primary {
      color: var(--text-primary);
    }

    .theme-inky .text-secondary {
      color: var(--text-secondary);
    }

    .theme-inky .bg-accent {
      background-color: var(--accent);
    }

    .theme-inky .bg-accent-light {
      background-color: var(--accent-light);
    }

    /* Apply similar for other themes */
    .theme-security {
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    .theme-security .bg-primary {
      background-color: var(--bg-primary);
    }

    .theme-security .bg-secondary {
      background-color: var(--bg-secondary);
    }

    .theme-security .text-primary {
      color: var(--text-primary);
    }

    .theme-security .text-secondary {
      color: var(--text-secondary);
    }

    .theme-security .bg-accent {
      background-color: var(--accent);
    }

    .theme-security .bg-accent-light {
      background-color: var(--accent-light);
    }


    .theme-crisis {
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    .theme-crisis .bg-primary {
      background-color: var(--bg-primary);
    }

    .theme-crisis .bg-secondary {
      background-color: var(--bg-secondary);
    }

    .theme-crisis .text-primary {
      color: var(--text-primary);
    }

    .theme-crisis .text-secondary {
      color: var(--text-secondary);
    }

    .theme-crisis .bg-accent {
      background-color: var(--accent);
    }

    .theme-crisis .bg-accent-light {
      background-color: var(--accent-light);
    }

    .theme-fancy {
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    .theme-fancy .bg-primary {
      background-color: var(--bg-primary);
    }

    .theme-fancy .bg-secondary {
      background-color: var(--bg-secondary);
    }

    .theme-fancy .text-primary {
      color: var(--text-primary);
    }

    .theme-fancy .text-secondary {
      color: var(--text-secondary);
    }

    .theme-fancy .bg-accent {
      background-color: var(--accent);
    }

    .theme-fancy .bg-accent-light {
      background-color: var(--accent-light);
    }

    /* Light Theme (default) */
    .theme-light {
      --headerbg-primary: #1a5bb8;
      --bg-primary: #ffffff;
      --bg-secondary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #374151;
      --accent: #3b82f6;
      --accent-light: #93c5fd;
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }
    .theme-light .bg-primary { background-color: var(--bg-primary); }
    .theme-light .bg-secondary { background-color: var(--bg-secondary); }
    .theme-light .text-primary { color: var(--text-primary); }
    .theme-light .text-secondary { color: var(--text-secondary); }
    .theme-light .bg-accent { background-color: var(--accent); }
    .theme-light .bg-accent-light { background-color: var(--accent-light); }

    /* Dark Theme */
    .theme-dark {
      --headerbg-primary: #1547b3;
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --text-primary: #111827;
      --text-secondary: #9ca3af;
      --accent: #60a5fa;
      --accent-light: #93c5fd;
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }
    .theme-dark .bg-primary { background-color: var(--bg-primary); }
    .theme-dark .bg-secondary { background-color: var(--bg-secondary); }
    .theme-dark .text-primary { color: var(--text-primary); }
    .theme-dark .text-secondary { color: var(--text-secondary); }
    .theme-dark .bg-accent { background-color: var(--accent); }
    .theme-dark .bg-accent-light { background-color: var(--accent-light); }

    /* NOVAMUN Theme - Space-inspired cosmic aesthetic */
    .theme-novamun {
      --headerbg-primary: #0a0e1a;
      --bg-primary: #000000;
      --bg-secondary: #0d1117;
      --text-primary: #e6f1ff;
      --text-secondary: #7ba5d1;
      --accent: #4a9eff;
      --accent-light: #6eb5ff;
      background: linear-gradient(135deg, #000000 0%, #0a0e1a 50%, #000814 100%);
      color: var(--text-primary);
      position: relative;
    }
    
    /* Space background effect for NOVAMUN theme */
    .theme-novamun::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(74, 158, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(110, 181, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(123, 165, 209, 0.03) 0%, transparent 30%);
      pointer-events: none;
      z-index: 0;
    }
    
    .theme-novamun * {
      position: relative;
      z-index: 1;
    }
    
    .theme-novamun .bg-primary { 
      background-color: rgba(13, 17, 23, 0.6);
      backdrop-filter: blur(10px);
    }
    .theme-novamun .bg-secondary { 
      background-color: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(74, 158, 255, 0.15);
    }
    .theme-novamun .text-primary { 
      color: #e6f1ff;
      text-shadow: 0 0 20px rgba(74, 158, 255, 0.3);
    }
    .theme-novamun .text-secondary { 
      color: #7ba5d1; 
    }
    .theme-novamun .bg-accent { 
      background: linear-gradient(135deg, #4a9eff 0%, #6eb5ff 100%);
      box-shadow: 0 0 20px rgba(74, 158, 255, 0.4);
    }
    .theme-novamun .bg-accent-light { 
      background-color: rgba(74, 158, 255, 0.2);
      border: 1px solid rgba(74, 158, 255, 0.4);
    }
    
    /* Glowing cards for NOVAMUN theme */
    .theme-novamun .border {
      border-color: rgba(74, 158, 255, 0.2) !important;
      box-shadow: 0 0 15px rgba(74, 158, 255, 0.1);
    }
    
    .theme-novamun .rounded-lg {
      background: rgba(13, 17, 23, 0.6);
      backdrop-filter: blur(10px);
    }
    
    /* Button glow effects for NOVAMUN */
    .theme-novamun button {
      transition: all 0.3s ease;
    }
    
    .theme-novamun button:hover {
      box-shadow: 0 0 20px rgba(74, 158, 255, 0.5);
      transform: translateY(-1px);
    }
    
    /* Header styling for NOVAMUN */
    .theme-novamun header {
      background: linear-gradient(135deg, #0a0e1a 0%, #000814 100%) !important;
      box-shadow: 0 4px 30px rgba(74, 158, 255, 0.2);
      border-bottom: 1px solid rgba(74, 158, 255, 0.3);
    }
    
    /* Tab bar styling for NOVAMUN */
    .theme-novamun #tabBar {
      background: linear-gradient(90deg, #0a0e1a 0%, #4a4a52 20%, #b8b4a8 50%, #4a4a52 80%, #0a0e1a 100%) !important;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.5);
    }
    
    .theme-novamun #tabBar button {
      color: #e6f1ff !important;
      transition: all 0.3s ease;
    }
    
    .theme-novamun #tabBar button:hover {
      background: rgba(74, 158, 255, 0.2) !important;
      box-shadow: 0 0 15px rgba(74, 158, 255, 0.4);
    }
    
    /* NOVAMUN delegate status glows */
    .theme-novamun .delegate-card.status-present {
      border: 2px solid #22c55e !important;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.5), 0 0 40px rgba(34, 197, 94, 0.2);
      background: rgba(34, 197, 94, 0.05) !important;
    }
    
    .theme-novamun .delegate-card.status-present-voting {
      border: 2px solid #3b82f6 !important;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5), 0 0 40px rgba(59, 130, 246, 0.2);
      background: rgba(59, 130, 246, 0.05) !important;
    }
    
    .theme-novamun .delegate-card.status-absent {
      border: 2px solid #ef4444 !important;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5), 0 0 40px rgba(239, 68, 68, 0.2);
      background: rgba(239, 68, 68, 0.05) !important;
    }
    
    /* Quick actions styling for all themes */
    .theme-novamun .quick-action-btn {
      box-shadow: 0 0 15px rgba(74, 158, 255, 0.3);
    }
    
    .theme-novamun .quick-action-btn:hover {
      box-shadow: 0 0 25px rgba(74, 158, 255, 0.5);
      transform: translateY(-2px);
    }
    
    /* Speaker list drag and drop */
    .speaker-item {
      transition: all 0.2s ease;
    }
    
    .speaker-item:hover {
      transform: translateY(-2px);
      cursor: grab;
    }
    
    .speaker-item:active {
      cursor: grabbing;
    }
    
    .speaker-item.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    
    /* Theme support for speaker items */
    .theme-dark .speaker-item {
      background-color: #1f2937;
      border-color: #374151;
    }
    
    .theme-dark .speaker-item span {
      color: #e5e7eb;
    }
    
    .theme-novamun .speaker-item {
      background-color: rgba(13, 17, 23, 0.8);
      border-color: rgba(74, 158, 255, 0.3);
      box-shadow: 0 0 10px rgba(74, 158, 255, 0.1);
    }
    
    .theme-novamun .speaker-item:hover {
      box-shadow: 0 0 20px rgba(74, 158, 255, 0.3);
    }
    
    .theme-novamun .speaker-item span {
      color: #e6f1ff;
    }
    
    /* Ranking card theme support */
    .ranking-card {
      background-color: white;
      color: #111827;
    }
    
    .ranking-title {
      color: #111827;
    }
    
    .ranking-subtitle {
      color: #6b7280;
    }
    
    .ranking-label {
      color: #374151;
    }
    
    .ranking-text {
      color: #111827;
    }
    
    .ranking-points {
      color: #1f2937;
    }
    
    .ranking-border {
      border-color: #e5e7eb;
    }
    
    /* Dark theme ranking cards */
    .theme-dark .ranking-card {
      background-color: #1f2937;
      border-color: #374151;
    }
    
    .theme-dark .ranking-title,
    .theme-dark .ranking-label,
    .theme-dark .ranking-text,
    .theme-dark .ranking-points {
      color: #e5e7eb;
    }
    
    .theme-dark .ranking-subtitle {
      color: #9ca3af;
    }
    
    .theme-dark .ranking-border {
      border-color: #374151;
    }
    
    /* NOVAMUN theme ranking cards */
    .theme-novamun .ranking-card {
      background-color: rgba(13, 17, 23, 0.8);
      border-color: rgba(74, 158, 255, 0.3);
      box-shadow: 0 0 15px rgba(74, 158, 255, 0.2);
    }
    
    .theme-novamun .ranking-title,
    .theme-novamun .ranking-label,
    .theme-novamun .ranking-text {
      color: #e6f1ff;
    }
    
    .theme-novamun .ranking-subtitle {
      color: rgba(230, 241, 255, 0.7);
    }
    
    .theme-novamun .ranking-points {
      color: #4a9eff;
      text-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
    }
    
    .theme-novamun .ranking-border {
      border-color: rgba(74, 158, 255, 0.2);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Theme-specific scrollbars */
    .theme-inky ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .theme-inky ::-webkit-scrollbar-thumb {
      background: var(--accent);
    }

    .theme-security ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    .theme-security ::-webkit-scrollbar-thumb {
      background: var(--text-secondary);
    }

    .theme-crisis ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .theme-crisis ::-webkit-scrollbar-thumb {
      background: var(--accent);
    }

    .theme-fancy ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .theme-fancy ::-webkit-scrollbar-thumb {
      background: var(--accent-light);
    }

    /* Custom animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .pulse-animation {
      animation: pulse 2s infinite;
    }

    /* For crisis timer */
    @keyframes crisisFlash {
      0%, 100% { background-color: #7f1d1d; }
      50% { background-color: #450a0a; }
    }

    .crisis-flash {
      animation: crisisFlash 1s infinite;
    }

    /* Custom badge styles */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }


    /* Delegate card */
    .delegate-card {
      transition: all 0.2s;
    }

    .delegate-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Custom toggle switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 3.5rem;
      height: 1.75rem;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 1.75rem;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 1.25rem;
      width: 1.25rem;
      left: 0.25rem;
      bottom: 0.25rem;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: #3b82f6;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(1.75rem);
    }

    /* Crisis icon */
    .crisis-icon {
      font-family: 'Times New Roman', serif;
      font-weight: bold;
    }

    /* New header style */
    .header-gradient {
      /* Changed to a darker, more neutral gradient */
      background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    }

    .compact-button {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .compact-input {
      padding: 0.5rem;
      font-size: 0.875rem;
    }

    .compact-select {
      padding: 0.5rem 1.75rem 0.5rem 0.75rem;
      font-size: 0.875rem;
    }

    .flag-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Country selector modal styles - Fixed for all themes */
    .country-selector-modal {
      background-color: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      color: #111827 !important;
    }
    
    .country-selector-modal h3,
    .country-selector-modal label,
    .country-selector-modal .country-item,
    .country-selector-modal .text-sm,
    .country-selector-modal .text-gray-700,
    .country-selector-modal p {
      color: #111827 !important;
    }
    
    .country-selector-modal input,
    .country-selector-modal select,
    .country-selector-modal textarea {
      color: #111827 !important;
      background-color: white !important;
      border-color: #d1d5db !important;
    }
    
    .country-selector-modal input::placeholder,
    .country-selector-modal textarea::placeholder {
      color: #6b7280 !important;
    }
    
    /* NOVAMUN theme modal fixes */
    .theme-novamun .country-selector-modal {
      background-color: #1a1a2e !important;
      border: 2px solid rgba(74, 158, 255, 0.3);
      box-shadow: 0 0 30px rgba(74, 158, 255, 0.2);
    }
    
    .theme-novamun .country-selector-modal h3,
    .theme-novamun .country-selector-modal label,
    .theme-novamun .country-selector-modal .country-item,
    .theme-novamun .country-selector-modal .text-sm,
    .theme-novamun .country-selector-modal .text-gray-700,
    .theme-novamun .country-selector-modal p {
      color: #e6f1ff !important;
    }
    
    .theme-novamun .country-selector-modal input,
    .theme-novamun .country-selector-modal select,
    .theme-novamun .country-selector-modal textarea {
      background-color: rgba(13, 17, 23, 0.8) !important;
      border: 1px solid rgba(74, 158, 255, 0.3) !important;
      color: #e6f1ff !important;
    }
    
    .theme-novamun .country-selector-modal input::placeholder,
    .theme-novamun .country-selector-modal textarea::placeholder {
      color: rgba(230, 241, 255, 0.5) !important;
    }
    
    .theme-novamun .country-selector-modal .country-item {
      background-color: rgba(13, 17, 23, 0.5);
      border-color: rgba(74, 158, 255, 0.2) !important;
    }
    
    .theme-novamun .country-selector-modal .country-item:hover {
      background-color: rgba(74, 158, 255, 0.1);
      border-color: rgba(74, 158, 255, 0.4) !important;
    }

    /* Roomier custom delegate controls inside selector */
    #countrySelectorModal .country-selector-modal {
      gap: 0.75rem;
    }
    #countrySelectorModal .country-selector-modal .compact-input,
    #countrySelectorModal .country-selector-modal .compact-select {
      padding: 0.75rem;
      font-size: 1rem;
    }
    #countrySelectorModal .country-selector-modal .modal-button {
      padding: 0.6rem 1rem;
      font-size: 0.95rem;
    }
    /* Center modal action buttons in Add Delegate modal */
    #countrySelectorModal .modal-actions {
      justify-content: center;
      gap: 1rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }
    #countrySelectorModal .modal-actions .modal-button {
      margin-left: 0.25rem; /* fallback spacing if gap not applied */
      margin-right: 0.25rem;
    }
    #countrySelectorModal #toggleCustomDelegateArea {
      width: 100%;
    }

    .country-search {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.25rem;
    }

    .country-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }

    .country-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
    }

    .country-item:hover {
      background-color: #f9fafb;
    }

    .country-item input {
      margin-right: 0.75rem;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }

    /* General modal styling fixes for all themes */
    #quickMotionPopup > div,
    #resolutionPopup > div,
    #timerPopup > div,
    #editSpeakerModal > div,
    #settingsModal > div > div,
    #credentialsModal > div {
      background-color: white;
      color: #111827;
    }
    
    #quickMotionPopup h3,
    #resolutionPopup h3,
    #timerPopup h3,
    #editSpeakerModal h3,
    #settingsModal h3,
    #settingsModal h2,
    #settingsModal label,
    #settingsModal .text-gray-700,
    #settingsModal .text-gray-800,
    #credentialsModal h2,
    #credentialsModal label {
      color: #111827 !important;
    }
    
    /* NOVAMUN theme modal fixes */
    .theme-novamun #quickMotionPopup > div,
    .theme-novamun #resolutionPopup > div,
    .theme-novamun #timerPopup > div,
    .theme-novamun #editSpeakerModal > div,
    .theme-novamun #credentialsModal > div {
      background-color: #1a1a2e !important;
      border: 2px solid rgba(74, 158, 255, 0.3);
      box-shadow: 0 0 30px rgba(74, 158, 255, 0.2);
      color: #e6f1ff !important;
    }
    
    .theme-novamun #quickMotionPopup h3,
    .theme-novamun #resolutionPopup h3,
    .theme-novamun #timerPopup h3,
    .theme-novamun #editSpeakerModal h3,
    .theme-novamun #credentialsModal h2 {
      color: #e6f1ff !important;
    }
    
    .theme-novamun #quickMotionPopup input,
    .theme-novamun #quickMotionPopup select,
    .theme-novamun #quickMotionPopup textarea,
    .theme-novamun #resolutionPopup input,
    .theme-novamun #resolutionPopup select,
    .theme-novamun #resolutionPopup textarea,
    .theme-novamun #timerPopup input,
    .theme-novamun #timerPopup select,
    .theme-novamun #editSpeakerModal input,
    .theme-novamun #editSpeakerModal select {
      background-color: rgba(13, 17, 23, 0.8) !important;
      border: 1px solid rgba(74, 158, 255, 0.3) !important;
      color: #e6f1ff !important;
    }
    
    .theme-novamun #quickMotionPopup input::placeholder,
    .theme-novamun #quickMotionPopup textarea::placeholder,
    .theme-novamun #resolutionPopup input::placeholder,
    .theme-novamun #resolutionPopup textarea::placeholder,
    .theme-novamun #timerPopup input::placeholder,
    .theme-novamun #editSpeakerModal input::placeholder {
      color: rgba(230, 241, 255, 0.5) !important;
    }
    
    /* Chair Tools Modal specific fixes */
    .theme-novamun #settingsModal .bg-white {
      background-color: #1a1a2e !important;
      color: #e6f1ff !important;
    }
    
    .theme-novamun #settingsModal .bg-gray-50 {
      background-color: rgba(13, 17, 23, 0.6) !important;
    }
    
    .theme-novamun #settingsModal h2,
    .theme-novamun #settingsModal h3,
    .theme-novamun #settingsModal label,
    .theme-novamun #settingsModal .text-gray-700,
    .theme-novamun #settingsModal .text-gray-800,
    .theme-novamun #settingsModal .text-gray-600 {
      color: #e6f1ff !important;
    }
    
    .theme-novamun #settingsModal input,
    .theme-novamun #settingsModal select,
    .theme-novamun #settingsModal textarea {
      background-color: rgba(13, 17, 23, 0.8) !important;
      border-color: rgba(74, 158, 255, 0.3) !important;
      color: #e6f1ff !important;
    }
    
    .theme-novamun #settingsModal input::placeholder,
    .theme-novamun #settingsModal textarea::placeholder {
      color: rgba(230, 241, 255, 0.5) !important;
    }
    
    .theme-novamun #settingsModal .border-gray-200,
    .theme-novamun #settingsModal .border-gray-300 {
      border-color: rgba(74, 158, 255, 0.2) !important;
    }
    
    .theme-novamun #settingsModal .theme-card:hover {
      border-color: rgba(74, 158, 255, 0.5) !important;
    }

    .modal-button {
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      cursor: pointer;
    }

    .modal-button-primary {
      background-color: #3b82f6;
      color: white;
      border: none;
    }

    .modal-button-secondary {
      background-color: #e5e7eb;
      color: #374151;
      border: none;
    }

    /* Improved roll call styles */
    .roll-call-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }

    .delegate-status-badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
    }

    /* Improved header styles */
    .header-content {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 1rem;
    }

    .header-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .logo-container {
      position: relative;
      margin: 0 auto;
      width: fit-content;
    }

    /* Improved button styles */
    .action-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .action-button:hover {
      transform: translateY(-1px);
    }

    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile responsive adjustments */
    @media (max-width: 640px) {
      .header-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .header-actions .action-button {
        width: 100%;
      }

      .roll-call-grid {
        grid-template-columns: 1fr;
      }

      .modal {
        width: 95%;
        max-width: 95%;
      }
    }

    /* Better contrast for notifications */
    .notification-success {
      background-color: #10b981;
      color: white;
    }

    .notification-error {
      background-color: #ef4444;
      color: white;
    }

    .notification-warning {
      background-color: #f59e0b;
      color: white;
    }

    /* More prominent current speaker display */
    .current-speaker-display {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Settings modal styles */
    .settings-modal {
      background-color: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .settings-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .settings-section:last-child {
      border-bottom: none;
    }

    /* Login modal styles */
    .login-modal {
      background-color: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .login-input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.25rem;
    }


    /* Export/import section */
    .data-export {
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 1rem;
    }

    /* Confirmation dialog */
    .confirmation-dialog {
      background-color: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    /* Star rating specific CSS */
    .star-rating .fa-star {
      color: #ccc; /* Default star color */
      cursor: pointer;
      transition: color 0.2s;
    }

    .star-rating .fa-star.active {
      color: #facc15; /* Active star color (yellow-500 equivalent) */
    }



    /* Future Light Theme */
    .theme-future-light {
      background-color: #fff;
      color: #992450;
    }
    .theme-future-light .bg-primary { background-color: #fff; }
    .theme-future-light .bg-secondary { background-color: #992450; }
    .theme-future-light .text-primary { color: #3C071B; }
    .theme-future-light .text-secondary { color: #992450; }
    .theme-future-light .bg-accent { background-color: #992450; }
    .theme-future-light .bg-accent-light { background-color: #3C071B; }

    /* Future Dark Theme */
    .theme-future-dark {
      background-color: #000000;
      color: #fff;
    }
    .theme-future-dark .bg-primary { background-color: #000000; }
    .theme-future-dark .bg-secondary { background-color: #3C071B; }
    .theme-future-dark .text-primary { color: #992450; }
    .theme-future-dark .text-secondary { color: #fff; }
    .theme-future-dark .bg-accent { background-color: #992450; }
    .theme-future-dark .bg-accent-light { background-color: #3C071B; }

    /* Unity Light Theme */
    .theme-unity-light {
      background-color: #d5dfe6;
      color: #5b6570;
    }
    .theme-unity-light .bg-primary { background-color: #d5dfe6; }
    .theme-unity-light .bg-secondary { background-color: #a4b3be; }
    .theme-unity-light .text-primary { color: #5b6570; }
    .theme-unity-light .text-secondary { color: #bac7d2; }
    .theme-unity-light .bg-accent { background-color: #a4b3be; }
    .theme-unity-light .bg-accent-light { background-color: #bac7d2; }

    /* Unity Dark Theme */
    .theme-unity-dark {
      background-color: #5b6570;
      color: #fff;
    }
    .theme-unity-dark .bg-primary { background-color: #5b6570; }
    .theme-unity-dark .bg-secondary { background-color: #a4b3be; }
    .theme-unity-dark .text-primary { color: #d5dfe6; }
    .theme-unity-dark .text-secondary { color: #bac7d2; }
    .theme-unity-dark .bg-accent { background-color: #a4b3be; }
    .theme-unity-dark .bg-accent-light { background-color: #d5dfe6; }

    @keyframes spin-fast {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .animate-spin-fast {
      animation: spin-fast 0.6s cubic-bezier(.4,0,.2,1);
    }
  </style>
</head>
<body class="font-sans theme-novamun">
<!-- LOGIN OVERLAY -->
<div id="loginOverlay" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-blue-100 to-blue-300 z-50 transition-all duration-500">
  <div class="flex flex-col items-center w-full h-full justify-center">
    <div class="mb-8 flex flex-col items-center">
      <img src="https://i.ibb.co/NwvtCRS/CA97-A93-D-A4-E8-4-EC5-802-B-F587-DC5-FAA86.jpg" alt="ChairLink Logo" class="w-16 h-16 rounded-full shadow-lg mb-2">
      <span class="text-2xl font-bold text-blue-800 tracking-tight">ChairLink</span>
    </div>
    <div class="bg-white rounded-2xl shadow-2xl px-8 py-10 w-full max-w-md flex flex-col items-center animate-fadeIn">
      <h2 class="text-2xl font-bold text-blue-900 mb-2 text-center">Good to see you again</h2>
      <form id="loginForm" class="w-full mt-4 space-y-5" onsubmit="return performLogin(event);">
        <div>
          <label class="block text-sm font-semibold mb-1 text-gray-700" for="loginUsername">Your username</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i class="fas fa-user"></i></span>
            <input id="loginUsername" type="text" autocomplete="username" placeholder="Enter committee code (e.g. UNSC1)" class="w-full pl-10 pr-3 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition text-base bg-gray-50"/>
          </div>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1 text-gray-700" for="loginPassword">Your password</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i class="fas fa-lock"></i></span>
            <input id="loginPassword" type="password" autocomplete="current-password" placeholder="Same as your username" class="w-full pl-10 pr-3 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition text-base bg-gray-50"/>
          </div>
        </div>
        <button type="submit" id="loginSubmit" class="w-full bg-gradient-to-r from-blue-400 to-blue-600 hover:from-blue-500 hover:to-blue-700 text-white font-semibold py-3 rounded-lg transition text-lg shadow">Sign in</button>
        <div id="loginError" class="text-red-600 text-center font-medium hidden"></div>
      </form>
      
      <!-- Note: Google Sign-In temporarily disabled due to CORS restrictions on static hosting -->
      
      <div class="mt-6 flex flex-col items-center gap-2 text-sm text-blue-700">
        <button type="button" onclick="showLoginHelp()" class="hover:underline font-semibold">📋 View Committee Login Credentials</button>
        <p class="text-xs text-gray-500 mt-2">For NOVAMUN Chairs: Username and password are the same</p>
      </div>
    </div>
  </div>
</div>
<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-white z-50" style="display:none;">
  <div class="flex flex-col items-center">
    <div class="relative w-32 h-32 flex items-center justify-center">
      <img src="https://i.ibb.co/NwvtCRS/CA97-A93-D-A4-E8-4-EC5-802-B-F587-DC5-FAA86.jpg" alt="ChairLink Logo" class="w-24 h-24 rounded-full shadow-lg"/>
      <svg class="absolute top-0 left-0 w-32 h-32" viewBox="0 0 128 128">
        <!-- Outer rotating ring -->
        <circle cx="64" cy="64" r="56" fill="none" stroke="#2979ff" stroke-width="6" stroke-linecap="round" stroke-dasharray="280" stroke-dashoffset="280">
          <animateTransform attributeName="transform" type="rotate" from="0 64 64" to="360 64 64" dur="1.5s" repeatCount="indefinite"/>
          <animate attributeName="stroke-dashoffset" values="280;0;280" dur="1.5s" repeatCount="indefinite"/>
        </circle>
        <!-- Inner pulsing ring -->
        <circle cx="64" cy="64" r="48" fill="none" stroke="#60a5fa" stroke-width="3" stroke-opacity="0.6">
          <animate attributeName="r" values="48;52;48" dur="2s" repeatCount="indefinite"/>
          <animate attributeName="stroke-opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/>
        </circle>
      </svg>
    </div>
    <div class="mt-6 text-xl font-bold text-blue-700 tracking-wide animate-pulse">Loading ChairLink...</div>
  </div>
</div>

<!-- CREDENTIALS MODAL -->
<div id="credentialsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto m-4">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-2xl flex justify-between items-center">
      <div>
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <i class="fas fa-key"></i>
          NOVAMUN × CHAIRLINK CREDENTIALS
        </h2>
        <p class="text-blue-100 text-sm mt-1">Committee Login Information</p>
      </div>
      <button onclick="closeCredentialsModal()" class="text-white hover:text-gray-200 transition">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>
    
    <!-- Content -->
    <div class="p-6">
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
        <p class="text-blue-800 font-semibold flex items-center gap-2">
          <i class="fas fa-info-circle"></i>
          Username = Password for each chair
        </p>
        <p class="text-blue-600 text-sm mt-1">2 Chairs per Committee • 16 Accounts Total</p>
      </div>
      
      <!-- Credentials Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        
        <!-- UNSC -->
        <div class="border-2 border-blue-200 rounded-lg p-4 hover:border-blue-400 transition">
          <h3 class="font-bold text-lg text-blue-700 mb-3 flex items-center gap-2">
            <i class="fas fa-shield-alt"></i>
            UNSC (Security Council)
          </h3>
          <div class="space-y-2">
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 1:</span>
              <code class="bg-blue-100 text-blue-800 px-3 py-1 rounded font-mono">UNSC1</code>
            </div>
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 2:</span>
              <code class="bg-blue-100 text-blue-800 px-3 py-1 rounded font-mono">UNSC2</code>
            </div>
          </div>
        </div>
        
        <!-- UNHRC -->
        <div class="border-2 border-purple-200 rounded-lg p-4 hover:border-purple-400 transition">
          <h3 class="font-bold text-lg text-purple-700 mb-3 flex items-center gap-2">
            <i class="fas fa-balance-scale"></i>
            UNHRC (Human Rights)
          </h3>
          <div class="space-y-2">
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 1:</span>
              <code class="bg-purple-100 text-purple-800 px-3 py-1 rounded font-mono">UNHRC1</code>
            </div>
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 2:</span>
              <code class="bg-purple-100 text-purple-800 px-3 py-1 rounded font-mono">UNHRC2</code>
            </div>
          </div>
        </div>
        
        <!-- ICC -->
        <div class="border-2 border-red-200 rounded-lg p-4 hover:border-red-400 transition">
          <h3 class="font-bold text-lg text-red-700 mb-3 flex items-center gap-2">
            <i class="fas fa-gavel"></i>
            ICC (Criminal Court)
          </h3>
          <div class="space-y-2">
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 1:</span>
              <code class="bg-red-100 text-red-800 px-3 py-1 rounded font-mono">ICC1</code>
            </div>
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 2:</span>
              <code class="bg-red-100 text-red-800 px-3 py-1 rounded font-mono">ICC2</code>
            </div>
          </div>
        </div>
        
        <!-- HSC -->
        <div class="border-2 border-green-200 rounded-lg p-4 hover:border-green-400 transition">
          <h3 class="font-bold text-lg text-green-700 mb-3 flex items-center gap-2">
            <i class="fas fa-heartbeat"></i>
            HSC (Health Security)
          </h3>
          <div class="space-y-2">
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 1:</span>
              <code class="bg-green-100 text-green-800 px-3 py-1 rounded font-mono">HSC1</code>
            </div>
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 2:</span>
              <code class="bg-green-100 text-green-800 px-3 py-1 rounded font-mono">HSC2</code>
            </div>
          </div>
        </div>
        
        <!-- ADHOC -->
        <div class="border-2 border-yellow-200 rounded-lg p-4 hover:border-yellow-400 transition">
          <h3 class="font-bold text-lg text-yellow-700 mb-3 flex items-center gap-2">
            <i class="fas fa-users"></i>
            ADHOC (Ad Hoc Committee)
          </h3>
          <div class="space-y-2">
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 1:</span>
              <code class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded font-mono">ADHOC1</code>
            </div>
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 2:</span>
              <code class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded font-mono">ADHOC2</code>
            </div>
          </div>
        </div>
        
        <!-- CRISIS -->
        <div class="border-2 border-orange-200 rounded-lg p-4 hover:border-orange-400 transition">
          <h3 class="font-bold text-lg text-orange-700 mb-3 flex items-center gap-2">
            <i class="fas fa-exclamation-triangle"></i>
            CRISIS (Crisis Committee)
          </h3>
          <div class="space-y-2">
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 1:</span>
              <code class="bg-orange-100 text-orange-800 px-3 py-1 rounded font-mono">CRISIS1</code>
            </div>
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 2:</span>
              <code class="bg-orange-100 text-orange-800 px-3 py-1 rounded font-mono">CRISIS2</code>
            </div>
          </div>
        </div>
        
        <!-- UNOOSA -->
        <div class="border-2 border-indigo-200 rounded-lg p-4 hover:border-indigo-400 transition">
          <h3 class="font-bold text-lg text-indigo-700 mb-3 flex items-center gap-2">
            <i class="fas fa-rocket"></i>
            UNOOSA (Outer Space)
          </h3>
          <div class="space-y-2">
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 1:</span>
              <code class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded font-mono">UNOOSA1</code>
            </div>
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 2:</span>
              <code class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded font-mono">UNOOSA2</code>
            </div>
          </div>
        </div>
        
        <!-- UNICEF -->
        <div class="border-2 border-pink-200 rounded-lg p-4 hover:border-pink-400 transition">
          <h3 class="font-bold text-lg text-pink-700 mb-3 flex items-center gap-2">
            <i class="fas fa-child"></i>
            UNICEF (Children's Fund)
          </h3>
          <div class="space-y-2">
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 1:</span>
              <code class="bg-pink-100 text-pink-800 px-3 py-1 rounded font-mono">UNICEF1</code>
            </div>
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 2:</span>
              <code class="bg-pink-100 text-pink-800 px-3 py-1 rounded font-mono">UNICEF2</code>
            </div>
          </div>
        </div>
        
        <!-- WHO -->
        <div class="border-2 border-teal-200 rounded-lg p-4 hover:border-teal-400 transition">
          <h3 class="font-bold text-lg text-teal-700 mb-3 flex items-center gap-2">
            <i class="fas fa-hospital"></i>
            WHO (World Health)
          </h3>
          <div class="space-y-2">
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 1:</span>
              <code class="bg-teal-100 text-teal-800 px-3 py-1 rounded font-mono">WHO1</code>
            </div>
            <div class="bg-gray-50 p-2 rounded flex justify-between items-center">
              <span class="text-sm font-medium text-gray-600">Chair 2:</span>
              <code class="bg-teal-100 text-teal-800 px-3 py-1 rounded font-mono">WHO2</code>
            </div>
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- Footer -->
    <div class="bg-gray-50 p-4 rounded-b-2xl flex justify-between items-center">
      <p class="text-gray-600 text-sm">
        <i class="fas fa-lock mr-1"></i>
        Keep these credentials secure
      </p>
      <button onclick="closeCredentialsModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition">
        Close
      </button>
    </div>
  </div>
</div>

<div id="mainApp" style="display:none;"></div>
<header class="w-full" style="background: linear-gradient(135deg, var(--headerbg-primary) 0%, var(--headerbg-primary) 100%);">
  <div class="flex items-center justify-between px-6 py-3">
    <div class="flex items-center gap-3">
      <img alt="ChairLink Logo" class="w-12 h-12 rounded-full object-cover shadow-lg cursor-pointer" id="committeeLogo" src="https://i.ibb.co/NwvtCRS/CA97-A93-D-A4-E8-4-EC5-802-B-F587-DC5-FAA86.jpg"/>
      <h1 class="text-2xl font-extrabold text-white tracking-tight">ChairLink ×</h1>
      <img alt="NovaMUN Logo" class="w-12 h-12 rounded-full object-cover shadow-lg" src="https://iili.io/KPe4sR9.png" style="filter: drop-shadow(0 0 10px rgba(74, 158, 255, 0.6));"/>
    </div>
    <div class="flex items-center gap-2">
      <button class="compact-button px-4 py-2 bg-blue-700 text-white font-semibold rounded-lg shadow hover:bg-blue-800 flex items-center gap-1 text-sm" id="addDelegateBtn">
        <i class="fas fa-plus"></i> Add Delegate
      </button>
      <button class="compact-button px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow hover:bg-green-600 flex items-center gap-1 text-sm" id="saveBtn">
        <i class="fas fa-save"></i> Save
      </button>
      <button class="compact-button px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow hover:bg-purple-700 flex items-center gap-1 text-sm" id="exportDataBtn">
        <i class="fas fa-file-export"></i> Export
      </button>
      <button class="compact-button px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow hover:bg-indigo-700 flex items-center gap-1 text-sm" id="chairSettingsBtn" onclick="openChairSettings()">
        <i class="fas fa-sliders-h"></i> Chair Tools
      </button>
      <div class="h-6 w-px bg-white/30 mx-1"></div>
      <select class="compact-select border border-white/20 rounded-lg shadow bg-white/10 text-white font-semibold text-sm px-3 py-2 hover:bg-white/20 transition focus:outline-none focus:ring-2 focus:ring-white/50" id="themeSelector" style="appearance: auto;">
        <option value="light" style="color: black;">Light</option>
        <option value="dark" style="color: black;">Dark</option>
        <option value="novamun" selected style="color: black;">NOVAMUN</option>
        <option value="inky" style="color: black;">Inky</option>
        <option value="security" style="color: black;">Security</option>
        <option value="fancy" style="color: black;">Fancy</option>
      </select>
      <button onclick="logout()" class="compact-button px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow hover:bg-red-600 flex items-center gap-1 text-sm">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>
</header>
<div class="w-full flex flex-wrap justify-center items-center gap-2 shadow" id="tabBar" style="padding: 0.5rem 0; background: linear-gradient(90deg, #0a0e1a 0%, #4a4a52 20%, #b8b4a8 50%, #4a4a52 80%, #0a0e1a 100%);">
  <button class="compact-button px-4 py-2 rounded-lg flex items-center font-semibold hover:bg-white/10 transition focus:outline-none" onclick="showTab('dashboard')" id="tab-dashboard" style="color: #e6f1ff;">
    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
  </button>
  <button class="compact-button px-4 py-2 rounded-lg flex items-center font-semibold hover:bg-white/10 transition focus:outline-none" onclick="showTab('caucus')" id="tab-caucus" style="color: #e6f1ff;">
    <i class="fas fa-comments mr-2"></i>Debate & Notes
  </button>
  <button class="compact-button px-4 py-2 rounded-lg flex items-center font-semibold hover:bg-white/10 transition focus:outline-none" onclick="showTab('resolutions')" id="tab-resolutions" style="color: #e6f1ff;">
    <i class="fas fa-file-contract mr-2"></i>Documents
  </button>
  <button class="compact-button px-4 py-2 rounded-lg flex items-center font-semibold hover:bg-white/10 transition focus:outline-none" onclick="showTab('delegateRanking')" id="tab-delegateRanking" style="color: #e6f1ff;">
    <i class="fas fa-star mr-2"></i>Delegate Ranking
  </button>
</div>
<script>
// Tab bar active indicator logic - MOVED TO MAIN SCRIPT SECTION
// This placeholder ensures onclick handlers work
function showTab(tabId) {
  // Actual implementation is in the main script section below
  if (window.showTabImplementation) {
    window.showTabImplementation(tabId);
  }
}
</script>
<section class="p-4" id="dashboard">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div class="border rounded-lg p-4 bg-blue-50 shadow-sm">
<h3 class="font-semibold text-blue-800 flex items-center text-lg">
<i class="fas fa-users mr-2"></i>Delegates
        </h3>
<div class="mt-2 space-y-2">
<div class="flex justify-between text-base">
<span>Total:</span>
<span class="font-bold" id="totalDelegates">0</span>
</div>
<div class="flex justify-between text-base">
<span>Present:</span>
<span class="font-bold" id="presentDelegates">0</span>
</div>
<div class="flex justify-between text-base">
<span>Absent:</span>
<span class="font-bold" id="absentDelegates">0</span>
</div>
<div class="flex justify-between text-base">
<span>Speakers Queue:</span>
<span class="font-bold" id="speakersQueue">0</span>
</div>
</div>
</div>
<div class="border rounded-lg p-4 bg-green-50 shadow-sm">
<h3 class="font-semibold text-green-800 flex items-center text-lg">
<i class="fas fa-clock mr-2"></i>Committee Time
        </h3>
<div class="mt-2 space-y-2">
<div class="flex justify-between text-base">
<span>Session:</span>
<span class="font-bold" id="sessionTimer">00:00:00</span>
</div>
<div class="flex justify-between text-base">
<span>Current Speaker:</span>
<span class="font-bold" id="currentSpeakerTime">00:00</span>
</div>
<div class="flex justify-between text-base">
<span>Next Speaker:</span>
<span class="font-bold" id="nextSpeakerName">None</span>
</div>
<div class="flex justify-between text-base">
<span>Debate Mode:</span>
<span class="font-bold" id="debateMode">Formal Debate</span>
</div>
</div>
</div>
<div class="border rounded-lg p-4 bg-purple-50 shadow-sm">
<h3 class="font-semibold text-purple-800 flex items-center text-lg">
<i class="fas fa-chart-pie mr-2"></i>Stats
        </h3>
<div class="mt-2 space-y-2">
<div class="flex justify-between text-base">
<span>Motions:</span>
<span class="font-bold" id="totalMotions">0</span>
</div>
<div class="flex justify-between text-base">
<span>Resolutions:</span>
<span class="font-bold" id="totalResolutions">0</span>
</div>
<div class="flex justify-between text-base">
<span>Crisis Updates:</span>
<span class="font-bold" id="totalCrisis">0</span>
</div>
<div class="flex justify-between text-base">
<span>Speakers:</span>
<span class="font-bold" id="totalSpeakers">0</span>
</div>
</div>
</div>
</div>
<div class="border rounded-lg p-4 mb-6 shadow-sm">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-semibold text-blue-700 flex items-center">
<i class="fas fa-list-check mr-2"></i>Roll Call
        </h2>
<div class="flex gap-2 flex-wrap">
<button class="action-button bg-green-600 hover:bg-green-700 text-white text-sm font-semibold shadow" onclick="markAllPresent()">
<i class="fas fa-check mr-1"></i>All Present
          </button>
<button class="action-button bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold shadow" onclick="markAllPresentVoting()">
<i class="fas fa-check-double mr-1"></i>All P&V
          </button>
<button class="action-button bg-red-600 hover:bg-red-700 text-white text-sm font-semibold shadow" onclick="markAllAbsent()">
<i class="fas fa-times mr-1"></i>All Absent
          </button>
<button class="action-button bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold shadow" onclick="showRemoveDelegateModal()">
<i class="fas fa-user-minus mr-1"></i>Remove
          </button>
<button class="action-button bg-orange-600 hover:bg-orange-700 text-white text-sm font-semibold shadow" onclick="showImportDelegatesModal()">
<i class="fas fa-file-import mr-1"></i>Import PDF
          </button>
</div>
</div>
<div class="roll-call-grid" id="rollCall"></div>
</div>
<div class="border rounded-lg p-4 shadow-sm quick-actions-container">
<h2 class="text-xl font-semibold mb-4 text-blue-700 flex items-center">
<i class="fas fa-bolt mr-2"></i>Quick Actions
      </h2>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<button class="quick-action-btn p-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex flex-col items-center shadow-md transition" onclick="showQuickMotionPopup()">
<i class="fas fa-hand-paper text-3xl mb-2"></i>
<span class="text-sm font-semibold">New Motion</span>
</button>
<button class="quick-action-btn p-4 bg-green-600 hover:bg-green-700 text-white rounded-lg flex flex-col items-center shadow-md transition" onclick="addPointOfOrder()">
<i class="fas fa-hand-point-up text-3xl mb-2"></i>
<span class="text-sm font-semibold">Point of Order</span>
</button>
<button class="quick-action-btn p-4 bg-purple-600 hover:bg-purple-700 text-white rounded-lg flex flex-col items-center shadow-md transition" onclick="showResolutionPopup()">
<i class="fas fa-file-contract text-3xl mb-2"></i>
<span class="text-sm font-semibold">New Resolution</span>
</button>
<button class="quick-action-btn p-4 bg-orange-600 hover:bg-orange-700 text-white rounded-lg flex flex-col items-center shadow-md transition" onclick="showTab('caucus')">
<i class="fas fa-clock text-3xl mb-2"></i>
<span class="text-sm font-semibold">Start Caucus</span>
</button>
</div>
</div>
</section>
<section class="hidden p-4" id="caucus">
<div class="flex flex-col md:flex-row gap-6">
<div class="flex-1">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-semibold text-blue-700 flex items-center">
<i class="fas fa-users mr-2"></i>Speaker Lists
          </h2>
<div class="flex gap-2">
<button class="action-button bg-blue-500 text-white text-sm" onclick="showCountrySelector('speaker')">
<i class="fas fa-plus mr-1"></i>Add
            </button>
<button class="action-button bg-red-500 text-white text-sm" onclick="confirmClearSpeakerList('primary')">
<i class="fas fa-trash mr-1"></i>Clear
            </button>
</div>
</div>
<div class="mb-6">
<div class="flex justify-between items-center mb-2">
<h3 class="font-semibold text-lg">Primary List</h3>
<div class="flex gap-2">
<button class="action-button bg-purple-500 text-white text-sm" onclick="randomizeSpeakerList('primary')">
<i class="fas fa-random mr-1"></i>Randomize
              </button>
</div>
</div>
<div class="border rounded-lg p-3 min-h-40 max-h-96 overflow-y-auto space-y-2 shadow-sm" id="primarySpeakerList"></div>
</div>
<h2 class="text-xl font-semibold mb-4 mt-6 text-blue-700 flex items-center">
<i class="fas fa-clock mr-2"></i>Caucus Controls
        </h2>
<div class="grid grid-cols-1 gap-4 mb-6">
<div class="border rounded-lg p-4 shadow-sm">
<h3 class="font-semibold mb-2 text-lg">Moderated Caucus</h3>
<div class="flex flex-col gap-3">
<input class="compact-input border rounded-lg text-base" id="modTopic" placeholder="Topic" type="text"/>
<div class="flex items-center gap-2">
<input class="compact-input border rounded-lg text-base flex-1" id="modDuration" placeholder="Duration" type="number" value="5"/>
<select class="compact-select border rounded-lg text-base">
<option>minutes</option>
<option>seconds</option>
</select>
</div>
<input class="compact-input border rounded-lg text-base" id="modSpeakerTime" placeholder="Speaker time (sec)" type="number" value="30"/>
<div class="flex gap-2">
<button class="action-button bg-blue-500 text-white flex-1" onclick="startModeratedCaucus()">
                  Start
                </button>
</div>
</div>
</div>
</div>
</div>
<div class="flex-1">
<h2 class="text-xl font-semibold mb-4 text-blue-700 flex items-center">
<i class="fas fa-user-tie mr-2"></i>Current Speaker
        </h2>
<div class="current-speaker-display p-6 w-full text-center mb-6 shadow-sm">
<div class="flex justify-between items-center mb-3">
<span class="font-semibold text-base">Speaker:</span>
<span class="font-bold text-white text-lg" id="currentSpeaker">No speaker</span>
</div>
<div class="flex justify-between items-center mb-4">
<span class="font-semibold text-base">Country:</span>
<span class="text-base flex items-center gap-2" id="currentSpeakerCountry">-</span>
</div>
<div class="flex justify-between items-center mb-6">
<span class="font-semibold text-base">Time:</span>
<div class="flex items-center">
<span class="text-4xl font-mono text-white" id="timer">01:30</span>
<div class="flex flex-col ml-3">
<button class="text-white hover:text-blue-200 mb-2 text-xl" onclick="adjustTime(-15)">
<i class="fas fa-minus-circle"></i>
</button>
<button class="text-white hover:text-blue-200 text-xl" onclick="adjustTime(15)">
<i class="fas fa-plus-circle"></i>
</button>
</div>
</div>
</div>
<div class="flex justify-center gap-3">
<button class="action-button bg-green-500 text-white" onclick="startTimer()">
<i class="fas fa-play mr-1"></i>Start
            </button>
<button class="action-button bg-yellow-500 text-white" onclick="pauseTimer()">
<i class="fas fa-pause mr-1"></i>Pause
            </button>
<button class="action-button bg-red-500 text-white" onclick="skipSpeaker()">
<i class="fas fa-forward mr-1"></i>Skip
            </button>
<button class="action-button bg-gray-500 text-white" onclick="resetSpeakerTimer()">
<i class="fas fa-undo mr-1"></i>Reset
            </button>
</div>
</div>
</div>
</div>
<!-- Committee Notes Section -->
<div class="border rounded-lg p-4 shadow-sm mt-6">
<h2 class="text-xl font-semibold mb-4 text-blue-700 flex items-center">
<i class="fas fa-book mr-2"></i>Committee Notes
</h2>
<textarea class="w-full h-64 border rounded-lg p-4 font-mono text-base shadow-sm" id="notebookText" placeholder="Take notes during debate..."></textarea>
<div class="mt-4 flex gap-2 flex-wrap">
<button class="action-button bg-blue-500 text-white" onclick="saveNote()">
<i class="fas fa-save mr-1"></i>Save
</button>
<button class="action-button bg-yellow-100 text-yellow-800 border border-yellow-200" onclick="insertTimestamp()">
<i class="fas fa-clock mr-1"></i>Timestamp
</button>
<button class="action-button bg-green-100 text-green-800 border border-green-200" onclick="exportNotes()">
<i class="fas fa-download mr-1"></i>Export
</button>
</div>
</div>
</section>
<section class="hidden p-4" id="resolutions">
<!-- Enhanced Documents Header -->
<div class="flex justify-between items-center mb-6">
<div>
<h2 class="text-2xl font-bold text-blue-700 flex items-center">
<i class="fas fa-folder-open mr-2"></i>Documents & Resolutions
        </h2>
<p class="text-gray-600 text-sm mt-1">Manage all committee documents, resolutions, and working papers</p>
</div>
<div class="flex gap-2">
<button class="action-button bg-blue-600 text-white shadow-lg hover:bg-blue-700" onclick="showResolutionPopup()">
<i class="fas fa-plus mr-1"></i>New Document
          </button>
<button class="action-button bg-green-600 text-white shadow-lg hover:bg-green-700" onclick="exportResolutions()">
<i class="fas fa-download mr-1"></i>Export All
          </button>
</div>
</div>

<!-- Document Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
<div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4 shadow">
<div class="flex items-center justify-between">
<div>
<p class="text-blue-600 text-sm font-semibold">Total Documents</p>
<p class="text-3xl font-bold text-blue-700" id="totalDocs">0</p>
</div>
<i class="fas fa-file-alt text-4xl text-blue-300"></i>
</div>
</div>
<div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-4 shadow">
<div class="flex items-center justify-between">
<div>
<p class="text-green-600 text-sm font-semibold">Approved</p>
<p class="text-3xl font-bold text-green-700" id="approvedDocs">0</p>
</div>
<i class="fas fa-check-circle text-4xl text-green-300"></i>
</div>
</div>
<div class="bg-gradient-to-br from-yellow-50 to-yellow-100 border border-yellow-200 rounded-lg p-4 shadow">
<div class="flex items-center justify-between">
<div>
<p class="text-yellow-600 text-sm font-semibold">In Progress</p>
<p class="text-3xl font-bold text-yellow-700" id="pendingDocs">0</p>
</div>
<i class="fas fa-clock text-4xl text-yellow-300"></i>
</div>
</div>
<div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-4 shadow">
<div class="flex items-center justify-between">
<div>
<p class="text-purple-600 text-sm font-semibold">Working Papers</p>
<p class="text-3xl font-bold text-purple-700" id="workingPapers">0</p>
</div>
<i class="fas fa-file-pen text-4xl text-purple-300"></i>
</div>
</div>
</div>

<!-- Search and Filter -->
<div class="bg-white border rounded-lg p-4 mb-4 shadow-sm">
<div class="flex flex-col md:flex-row gap-3">
<div class="flex-1">
<input type="text" id="docSearch" placeholder="Search documents by title, topic, or author..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
</div>
<select class="px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none" id="docFilter">
<option value="all">All Documents</option>
<option value="resolution">Resolutions</option>
<option value="working">Working Papers</option>
<option value="approved">Approved</option>
<option value="pending">Pending</option>
<option value="draft">Drafts</option>
</select>
<select class="px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none" id="docSort">
<option value="recent">Most Recent</option>
<option value="oldest">Oldest First</option>
<option value="title">By Title</option>
<option value="status">By Status</option>
</select>
</div>
</div>

<!-- Documents Table -->
<div class="border rounded-lg shadow-sm overflow-hidden bg-white">
<div class="overflow-x-auto">
<table class="min-w-full">
<thead class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
<tr>
<th class="py-4 px-4 text-left font-semibold">
<i class="fas fa-file mr-2"></i>Document
</th>
<th class="py-4 px-4 text-left font-semibold">
<i class="fas fa-tag mr-2"></i>Topic
</th>
<th class="py-4 px-4 text-left font-semibold">
<i class="fas fa-users mr-2"></i>Sponsors
</th>
<th class="py-4 px-4 text-left font-semibold">
<i class="fas fa-info-circle mr-2"></i>Status
</th>
<th class="py-4 px-4 text-left font-semibold">
<i class="fas fa-calendar mr-2"></i>Date
</th>
<th class="py-4 px-4 text-center font-semibold">
<i class="fas fa-tools mr-2"></i>Actions
</th>
</tr>
</thead>
<tbody id="resolutionList" class="divide-y divide-gray-200">
<!-- Documents will be dynamically inserted here -->
</tbody>
</table>
</div>
</div>

<!-- Empty State -->
<div id="emptyDocState" class="text-center py-16 hidden">
<i class="fas fa-folder-open text-6xl text-gray-300 mb-4"></i>
<h3 class="text-xl font-semibold text-gray-600 mb-2">No documents yet</h3>
<p class="text-gray-500 mb-6">Create your first resolution or working paper to get started</p>
<button class="action-button bg-blue-600 text-white shadow-lg" onclick="showResolutionPopup()">
<i class="fas fa-plus mr-2"></i>Create First Document
</button>
</div>
</section>

<!-- Delegate Ranking Tab -->
<section class="hidden p-4" id="delegateRanking">
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-blue-700 mb-2 flex items-center gap-2">
      <i class="fas fa-star"></i>
      Delegate Ranking
    </h2>
    <p class="text-gray-600">Rate delegates based on their performance throughout the session</p>
  </div>

  <!-- Search and Filter -->
  <div class="bg-white border rounded-lg p-4 mb-4 shadow-sm">
    <div class="flex flex-col md:flex-row gap-3">
      <input type="text" id="rankingSearch" placeholder="Search delegates by name or country..." class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
    </div>
  </div>

  <!-- Delegate Cards Grid -->
  <div id="delegateRankingGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <!-- Delegate cards will be inserted here -->
  </div>

  <!-- Empty State -->
  <div id="rankingEmptyState" class="hidden text-center py-12">
    <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
    <h3 class="text-xl font-semibold text-gray-700 mb-2">No Delegates Yet</h3>
    <p class="text-gray-500 mb-6">Add delegates to start ranking their performance</p>
    <button class="action-button bg-blue-600 text-white shadow-lg hover:bg-blue-700" onclick="document.getElementById('addDelegateBtn').click()">
      <i class="fas fa-plus mr-2"></i>Add Delegates
    </button>
  </div>
</section>

<!-- CHAIR TOOLS MODAL - Optimized for MUN Chairs -->
<div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden" id="settingsModal">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-t-2xl">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold flex items-center gap-2">
            <i class="fas fa-sliders-h"></i>
            Chair Tools & Settings
          </h2>
          <p class="text-indigo-100 text-sm mt-1">Configure your committee session</p>
        </div>
        <button onclick="closeModal('settingsModal')" class="text-white hover:text-gray-200 transition">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
    </div>
    
    <div class="p-6">
      <!-- Quick Actions Grid -->
      <div class="mb-6">
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-bolt text-yellow-500"></i>
          Quick Actions
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <button onclick="resetSessionTimer()" class="p-4 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-lg transition flex flex-col items-center gap-2">
            <i class="fas fa-clock text-blue-600 text-2xl"></i>
            <span class="text-sm font-semibold text-blue-800">Reset Timer</span>
          </button>
          <button onclick="saveData()" class="p-4 bg-green-50 hover:bg-green-100 border-2 border-green-200 rounded-lg transition flex flex-col items-center gap-2">
            <i class="fas fa-save text-green-600 text-2xl"></i>
            <span class="text-sm font-semibold text-green-800">Save Session</span>
          </button>
          <button onclick="exportData()" class="p-4 bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 rounded-lg transition flex flex-col items-center gap-2">
            <i class="fas fa-download text-purple-600 text-2xl"></i>
            <span class="text-sm font-semibold text-purple-800">Export Data</span>
          </button>
          <button onclick="confirmClearAllData()" class="p-4 bg-red-50 hover:bg-red-100 border-2 border-red-200 rounded-lg transition flex flex-col items-center gap-2">
            <i class="fas fa-trash-alt text-red-600 text-2xl"></i>
            <span class="text-sm font-semibold text-red-800">Clear All</span>
          </button>
        </div>
      </div>
      
      <!-- Committee Information -->
      <div class="mb-6 bg-gray-50 rounded-xl p-5 border border-gray-200">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-info-circle text-blue-600"></i>
          Committee Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Committee Name</label>
            <input id="committeeNameInput" type="text" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition" placeholder="e.g., UNSC, UNHRC"/>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Session Date</label>
            <input type="date" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition"/>
          </div>
        </div>
      </div>
      
      <!-- Timer Settings -->
      <div class="mb-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 border border-blue-200">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-stopwatch text-indigo-600"></i>
          Timer & Speaker Settings
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Default Speaker Time</label>
            <select id="speakerTimeInput" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition bg-white">
              <option value="30">30 seconds</option>
              <option value="60">1 minute</option>
              <option value="90" selected>1:30 minutes</option>
              <option value="120">2 minutes</option>
              <option value="180">3 minutes</option>
              <option value="300">5 minutes</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Moderated Caucus Time</label>
            <select class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition bg-white">
              <option value="300">5 minutes</option>
              <option value="600">10 minutes</option>
              <option value="900">15 minutes</option>
              <option value="1200">20 minutes</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Unmod Caucus Time</label>
            <select class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition bg-white">
              <option value="300">5 minutes</option>
              <option value="600">10 minutes</option>
              <option value="900">15 minutes</option>
              <option value="1200">20 minutes</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Theme & Display -->
      <div class="mb-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-5 border border-purple-200">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-palette text-purple-600"></i>
          Theme & Display
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <button onclick="changeTheme('light')" class="p-4 bg-white border-2 border-gray-300 hover:border-blue-500 rounded-lg transition shadow-md">
            <div class="w-full h-20 bg-gradient-to-br from-white to-gray-100 rounded mb-2 border border-gray-200"></div>
            <p class="text-sm font-bold text-center text-gray-800">Light</p>
          </button>
          <button onclick="changeTheme('dark')" class="p-4 bg-gray-800 border-2 border-gray-600 hover:border-blue-500 rounded-lg transition shadow-md">
            <div class="w-full h-20 bg-gradient-to-br from-gray-700 to-gray-900 rounded mb-2"></div>
            <p class="text-sm font-bold text-center text-white">Dark</p>
          </button>
          <button onclick="changeTheme('novamun')" class="p-4 bg-black border-2 border-blue-500 hover:border-blue-400 rounded-lg transition shadow-md">
            <div class="w-full h-20 bg-gradient-to-br from-black via-blue-900 to-black rounded mb-2"></div>
            <p class="text-sm font-bold text-center text-blue-300">NOVAMUN</p>
          </button>
        </div>
      </div>
      
      <!-- Advanced Options -->
      <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-cog text-gray-600"></i>
          Advanced Options
        </h3>
        <div class="space-y-3">
          <label class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:border-red-400 transition">
            <input id="crisisModeToggle" type="checkbox" class="w-5 h-5 text-red-600 rounded"/>
            <div>
              <span class="font-semibold text-gray-800">Crisis Mode</span>
              <p class="text-xs text-gray-600">Enable emergency committee features</p>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:border-blue-400 transition">
            <input type="checkbox" class="w-5 h-5 text-blue-600 rounded"/>
            <div>
              <span class="font-semibold text-gray-800">Auto-Save</span>
              <p class="text-xs text-gray-600">Automatically save every 5 minutes</p>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:border-green-400 transition">
            <input type="checkbox" class="w-5 h-5 text-green-600 rounded" checked/>
            <div>
              <span class="font-semibold text-gray-800">Speaker Notifications</span>
              <p class="text-xs text-gray-600">Play sound when timer ends</p>
            </div>
          </label>
        </div>
      </div>
      
      <!-- Data Import -->
      <div class="mt-6">
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-file-import mr-1"></i>
          Import Committee Data
        </label>
        <input accept=".json" id="importFileInput" type="file" class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer"/>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="bg-gray-50 p-6 rounded-b-2xl flex justify-between items-center border-t">
      <button onclick="applySettings()" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold rounded-lg transition shadow-lg">
        <i class="fas fa-check mr-2"></i>
        Apply Settings
      </button>
      <button onclick="closeModal('settingsModal')" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition">
        Cancel
      </button>
    </div>
    
  </div>
</div>

<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="countrySelectorModal">
<div class="country-selector-modal">
<h3 class="text-xl font-semibold mb-4" id="countrySelectorTitle">Select Delegates</h3>
<input class="country-search compact-input" id="countrySearchInput" placeholder="Search countries..." type="text"/>
<div class="flex gap-2 mb-3">
<button class="text-sm px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition" onclick="selectAllCountries()">
<i class="fas fa-check-double mr-1"></i>Select All
</button>
<button class="text-sm px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition" onclick="deselectAllCountries()">
<i class="fas fa-times mr-1"></i>Deselect All
</button>
<span class="text-sm text-gray-600 ml-auto self-center" id="selectionCount">0 selected</span>
</div>
<div class="country-list" id="countryList">
</div>
<div class="mt-3">
<button id="toggleCustomDelegateArea" class="modal-button modal-button-secondary">Add Custom Delegate</button>
<div id="customDelegateArea" class="hidden mt-3">
<label class="block text-sm font-medium text-gray-700 mb-1">Enter names separated by commas</label>
<textarea id="customDelegateNames" class="compact-input w-full p-2 border rounded-md" placeholder="Example: Name1, Name2, Name3"></textarea>
<div class="modal-actions mt-2">
<button class="modal-button modal-button-primary" id="addCustomDelegatesBtn">Add</button>
</div>
</div>

</div>
<div class="modal-actions">
<button class="modal-button modal-button-secondary" onclick="closeModal('countrySelectorModal')">Cancel</button>
<button class="modal-button modal-button-primary" id="addSelectedCountriesBtn">Add Selected</button>
</div>
</div>
</div>

<!-- Remove Delegate Modal (separate overlay) -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="removeDelegateModal">
<div class="country-selector-modal">
<h3 class="text-xl font-semibold mb-4">Remove Delegates</h3>
<input class="country-search compact-input" id="removeDelegateSearch" type="text" placeholder="Search delegates...">
<div class="country-list" id="removeDelegateList"></div>
<div class="modal-actions">
<button class="modal-button modal-button-secondary" onclick="closeModal('removeDelegateModal')">Cancel</button>
<button class="modal-button modal-button-primary" id="confirmRemoveDelegatesBtn">Remove Selected</button>
</div>
</div>
</div>

<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="quickMotionPopup">
<div class="bg-white rounded-lg p-6 shadow-xl w-96">
<h3 class="text-xl font-semibold mb-4">Propose Motion</h3>
<input class="compact-input w-full p-2 border rounded-md mb-3" id="motionTopic" placeholder="Motion topic (e.g., Unmoderated Caucus)" type="text"/>
<div class="flex items-center gap-2 mb-3">
<input class="compact-input flex-1 p-2 border rounded-md" id="motionDuration" placeholder="Duration" type="number"/>
<select class="compact-select p-2 border rounded-md" id="motionDurationUnit">
<option value="minutes">minutes</option>
<option value="seconds">seconds</option>
</select>
</div>
<input class="compact-input w-full p-2 border rounded-md mb-4" id="motionSpeakerTime" placeholder="Speaker Time (seconds, if applicable)" type="number"/>
<div class="flex justify-end gap-2">
<button class="modal-button modal-button-secondary" onclick="closeModal('quickMotionPopup')">Cancel</button>
<button class="modal-button modal-button-primary" onclick="addMotion()">Propose</button>
</div>
</div>
</div>

<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="resolutionPopup">
<div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-md">
<h3 class="text-xl font-semibold mb-4" id="resolutionPopupTitle">New Resolution</h3>
<input class="compact-input w-full p-2 border rounded-md mb-3" id="resolutionTitle" placeholder="Resolution Title (e.g., Draft Resolution 1.1)" type="text"/>
<input class="compact-input w-full p-2 border rounded-md mb-3" id="resolutionTopic" placeholder="Topic (e.g., Climate Change)" type="text"/>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="resolutionStatus">Status</label>
<select class="compact-select w-full p-2 border rounded-md" id="resolutionStatus">
<option value="draft">Draft</option>
<option value="submitted">Submitted</option>
<option value="passed">Passed</option>
<option value="failed">Failed</option>
</select>
</div>
<div class="flex justify-end gap-2">
<button class="modal-button modal-button-secondary" onclick="closeModal('resolutionPopup')">Cancel</button>
<button class="modal-button modal-button-primary" onclick="saveResolution()">Save</button>
</div>
</div>
</div>

<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="loginModal">
<div class="login-modal">
<h3 class="text-xl font-semibold mb-4">Login</h3>
<input class="login-input" id="usernameInput" placeholder="Username" type="text"/>
<input class="login-input" id="passwordInput" placeholder="Password" type="password"/>
<div class="modal-actions">
<button class="modal-button modal-button-secondary" onclick="closeModal('loginModal')">Cancel</button>
<button class="modal-button modal-button-primary" onclick="performLogin()">Login</button>
</div>
</div>
</div>

<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="confirmationDialog">
<div class="confirmation-dialog">
<h3 class="text-xl font-semibold mb-4" id="confirmationTitle">Confirm Action</h3>
<p class="mb-6" id="confirmationMessage">Are you sure you want to proceed?</p>
<div class="modal-actions">
<button class="modal-button modal-button-secondary" id="cancelConfirmBtn">Cancel</button>
<button class="modal-button modal-button-primary bg-red-500 hover:bg-red-600" id="confirmActionBtn">Confirm</button>
</div>
</div>
</div>

<!-- Import Delegates Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="importDelegatesModal">
<div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-6">
<h3 class="text-2xl font-bold text-gray-800">Import Delegates from PDF</h3>
<button class="text-gray-500 hover:text-gray-700 text-xl" onclick="closeModal('importDelegatesModal')">
<i class="fas fa-times"></i>
</button>
</div>

<div class="space-y-6">
<!-- File Upload Section -->
<div>
<h4 class="text-lg font-semibold mb-4 text-gray-700">Upload PDF File</h4>
<div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
<input type="file" id="pdfFileInput" accept=".pdf" class="hidden">
<button onclick="document.getElementById('pdfFileInput').click()" class="action-button bg-blue-500 text-white mb-4">
<i class="fas fa-upload mr-2"></i>Choose PDF File
</button>
<p class="text-sm text-gray-500">Upload a PDF containing delegate lists in format: NAME-DELEGATION</p>
<p class="text-xs text-gray-400 mt-2">Example: John Doe-Netherlands, Jane Doe-Poland</p>
</div>
<div id="fileInfo" class="hidden mt-3 p-3 bg-gray-100 rounded-lg">
<p class="text-sm font-medium text-gray-700" id="fileName"></p>
<p class="text-xs text-gray-500" id="fileSize"></p>
</div>
</div>

<!-- Processing Section -->
<div id="processingSection" class="hidden">
<h4 class="text-lg font-semibold mb-4 text-gray-700">Processing PDF...</h4>
<div class="bg-gray-100 rounded-lg p-4">
<div class="flex items-center">
<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mr-3"></div>
<span id="processingStatus">Extracting text from PDF...</span>
</div>
<div class="mt-3 bg-gray-200 rounded-full h-2">
<div id="processingProgress" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
</div>
</div>
</div>

<!-- Results Section -->
<div id="resultsSection" class="hidden">
<h4 class="text-lg font-semibold mb-4 text-gray-700">Found Delegates</h4>
<div class="max-h-64 overflow-y-auto border rounded-lg p-4 bg-gray-50">
<div id="delegatePreview" class="space-y-2">
<!-- Preview items will be added here -->
</div>
</div>
<div class="mt-4 flex items-center justify-between">
<div class="text-sm text-gray-600">
<span id="delegateCount">0</span> delegates found
</div>
<div class="flex gap-2">
<button class="action-button bg-gray-500 text-white" onclick="closeModal('importDelegatesModal')">
<i class="fas fa-times mr-1"></i>Cancel
</button>
<button class="action-button bg-green-500 text-white" id="confirmImportBtn">
<i class="fas fa-check mr-1"></i>Import Delegates
</button>
</div>
</div>
</div>

<!-- Error Section -->
<div id="errorSection" class="hidden">
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
<h4 class="font-bold">Import Failed</h4>
<p id="errorMessage" class="text-sm mt-1"></p>
<button class="mt-3 action-button bg-red-500 text-white" onclick="closeModal('importDelegatesModal')">
<i class="fas fa-times mr-1"></i>Close
</button>
</div>
</div>
</div>
</div>
</div>

<script>
    // ===== Google Sign-In Configuration =====
    // TODO: Replace this with your actual Google OAuth Client ID from https://console.cloud.google.com/
    const GOOGLE_CLIENT_ID = '462869100957-paefvanntcjb7sbnndos8t8fk1sv7dpr.apps.googleusercontent.com';
    
    // Initialize Google Sign-In on page load
    let googleSignInInitialized = false;
    
    function initializeGoogleSignIn() {
        if (typeof google !== 'undefined' && !googleSignInInitialized) {
            try {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleSignIn,
                    ux_mode: 'popup', // Use popup mode to avoid CORS issues
                    auto_select: false
                });
                googleSignInInitialized = true;
                console.log('Google Sign-In initialized successfully');
            } catch (error) {
                console.error('Error initializing Google Sign-In:', error);
            }
        }
    }
    
    // Try to initialize when page loads
    window.addEventListener('load', function() {
        setTimeout(initializeGoogleSignIn, 1000);
    });
    
    // Google Sign-In function
    function signInWithGoogle() {
        // Check if Google Sign-In library is loaded
        if (typeof google === 'undefined') {
            alert('Google Sign-In is still loading. Please wait a moment and try again.');
            setTimeout(initializeGoogleSignIn, 1000);
            return;
        }
        
        try {
            // Make sure it's initialized
            if (!googleSignInInitialized) {
                initializeGoogleSignIn();
            }
            
            // Show the popup
            google.accounts.id.prompt((notification) => {
                if (notification.isNotDisplayed()) {
                    console.log('Prompt was not displayed:', notification.getNotDisplayedReason());
                    // Fallback: try direct authorization
                    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                        `client_id=${GOOGLE_CLIENT_ID}&` +
                        `redirect_uri=${encodeURIComponent(window.location.origin)}&` +
                        `response_type=id_token&` +
                        `scope=openid%20email%20profile&` +
                        `nonce=${Date.now()}`;
                    
                    alert('Google Sign-In popup blocked. Please use committee login instead (e.g., UNSC1/UNSC1)');
                } else if (notification.isSkippedMoment()) {
                    console.log('Prompt was skipped');
                }
            });
            
        } catch (error) {
            console.error('Error with Google Sign-In:', error);
            alert('Google Sign-In is currently unavailable. Please use committee credentials instead:\n\nExamples:\nUNSC1 / UNSC1\nUNHRC1 / UNHRC1\nICC1 / ICC1');
        }
    }
    
    // Handle successful Google Sign-In
    function handleGoogleSignIn(response) {
        try {
            // Decode the JWT token to get user info
            const userInfo = parseJwt(response.credential);
            
            // Store user info
            const userData = {
                username: userInfo.email.split('@')[0], // Use email prefix as username
                email: userInfo.email,
                name: userInfo.name,
                picture: userInfo.picture,
                googleId: userInfo.sub,
                loginMethod: 'google'
            };
            
            localStorage.setItem('chairlinkUser', JSON.stringify(userData));
            localStorage.setItem('chairlinkLoginStatus', 'true');
            
            // Hide login overlay and show loading
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // Welcome message
            setTimeout(() => {
                showNotification(`Welcome, ${userData.name}!`, 'success');
                initializeApp();
            }, 1000);
            
        } catch (error) {
            console.error('Google Sign-In error:', error);
            showNotification('Sign-in failed. Please try again.', 'error');
        }
    }
    
    // Helper function to decode JWT token
    function parseJwt(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }
    
    // ===== Regular Login Function =====
    // Pre-built committee credentials for NOVAMUN collaboration
    const COMMITTEE_CREDENTIALS = [
        'UNSC1', 'UNSC2',
        'UNHRC1', 'UNHRC2',
        'ICC1', 'ICC2',
        'HSC1', 'HSC2',
        'ADHOC1', 'ADHOC2',
        'CRISIS1', 'CRISIS2',
        'UNOOSA1', 'UNOOSA2',
        'UNICEF1', 'UNICEF2',
        'WHO1', 'WHO2'
    ];
    
    function performLogin(event) {
        event.preventDefault();
        
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        const errorDiv = document.getElementById('loginError');
        
        // Hide previous errors
        errorDiv.classList.add('hidden');
        
        // Check if credentials are empty
        if (!username || !password) {
            errorDiv.textContent = 'Please enter both username and password';
            errorDiv.classList.remove('hidden');
            return false;
        }
        
        // Check if username/password match (for committee logins, password = username)
        const isValidCommittee = COMMITTEE_CREDENTIALS.includes(username.toUpperCase()) && 
                                 username.toUpperCase() === password.toUpperCase();
        
        // Also allow custom admin credentials (you can add more here)
        const isAdmin = username === 'admin' && password === 'admin123';
        
        if (isValidCommittee || isAdmin) {
            // Store user info
            const userData = {
                username: username.toUpperCase(),
                loginMethod: 'committee'
            };
            
            localStorage.setItem('chairlinkUser', JSON.stringify(userData));
            localStorage.setItem('chairlinkLoginStatus', 'true');
            
            // Hide login overlay and show loading
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // Welcome message
            setTimeout(() => {
                showNotification(`Welcome, ${userData.username}!`, 'success');
                initializeApp();
            }, 1000);
            
            return false;
        } else {
            errorDiv.textContent = 'Invalid credentials. Use committee login (e.g., UNSC1/UNSC1)';
            errorDiv.classList.remove('hidden');
            return false;
        }
    }
    
    let delegates = [];
    let resolutions = [];
    let currentDelegateCountry = '';
    let primarySpeakerList = [];
    let recentPoints = [];
    let sessionTimerInterval;
    let sessionTime = 0; // in seconds
    let sessionStartTime = Date.now(); // Track when session started
    let speakerTime = 90; // Default speaker time in seconds
    let timerInterval;
    let timerSeconds = 0;
    let votingHistory = [];
    let activeVoting = false;
    let activeVoteType = '';
    let activeVoteSubject = '';
    let activeVoteSessionId = null;
    let totalVotes = 0;
    let yesVotes = 0;
    let noVotes = 0;
    let abstainVotes = 0;
    let presentVotes = 0;
    let digitalVotingInterval = null;
    let currentSpeakerTimeInterval;
    let currentSpeakerSeconds = 0;
    let loginStatus = false;
    let crisisMode = false;
    let delegateRatings = {}; // Store ratings for each delegate {country: {criteria: rating}}
    let rankingCriteria = ['Speaking Quality', 'Negotiation Skills', 'Research Depth', 'Engagement', 'Diplomacy'];
    // SerpAPI (Google Images) key for fetching delegate photos
    const serpApiKey = 'a13ae05ee4238e4436c5aed56be537d2f8888392c860ce4450bda9720ac2f73a';

    // ===== App Initialization =====
    function initializeApp() {
        // Hide loading overlay and show main app
        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.body.style.overflow = 'auto';
            
            // Load existing data
            loadData();
            loadTheme();
            loadNotes();
            
            // Start session timer
            startSessionTimer();
            
            // Show dashboard by default
            showTab('dashboard');
        }, 500);
    }
    
    // ===== Session Timer =====
    function startSessionTimer() {
        if (sessionTimerInterval) clearInterval(sessionTimerInterval);
        sessionTimerInterval = setInterval(() => {
            sessionTime++;
            const hours = Math.floor(sessionTime / 3600);
            const minutes = Math.floor((sessionTime % 3600) / 60);
            const seconds = sessionTime % 60;
            document.getElementById('sessionTimer').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);
    }
    
    // ===== Logout Function =====
    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('chairlinkLoginStatus');
            location.reload();
        }
    }
    
    // ===== Login Help Function =====
    function showLoginHelp() {
        document.getElementById('credentialsModal').classList.remove('hidden');
    }
    
    function closeCredentialsModal() {
        document.getElementById('credentialsModal').classList.add('hidden');
    }

    // Function to show notification messages
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-lg text-white z-50 notification-${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Modal functions
    function showModal(id) {
        document.getElementById(id).classList.remove('hidden');
    }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
    }

    async function fetchImageForName(name) {
        try {
            if (!serpApiKey) return '';
            const query = encodeURIComponent(`${name} headshot`);
            const url = `https://serpapi.com/search.json?engine=google_images&q=${query}&api_key=${serpApiKey}&ijn=0&safe=active`;
            const res = await fetch(url);
            if (!res.ok) return '';
            const data = await res.json();
            const first = (data && data.images_results && data.images_results[0]) || null;
            const imageUrl = first?.thumbnail || first?.original || first?.link || '';
            return imageUrl || '';
        } catch (e) {
            return '';
        }
    }

    // Auto-save activity data for monitoring
    function saveActivityData() {
        try {
          const storedDocName = localStorage.getItem('chairlinkUser');
          if (!storedDocName) return;
          const DocName = JSON.parse(storedDocName);
          
          const activityData = {
            delegates: delegates,
            resolutions: resolutions,
            speakerList: primarySpeakerList,
            recentPoints: recentPoints,
            sessionTime: sessionTime,
            sessionStartTime: sessionStartTime,
            votingHistory: votingHistory,
            delegateRatings: delegateRatings,
            notebook: document.getElementById('chairNotes')?.value || '',
            committeeName: document.getElementById('committeeName')?.textContent || '',
            lastActivity: Date.now()
          };
          localStorage.setItem(`chairlink_${DocName.username}`, JSON.stringify(activityData));
        } catch (e) {
          console.error('Error auto-saving activity data:', e);
        }
    }
    
    // Data persistence
    async function saveData() {
        const storedDocName = localStorage.getItem('chairlinkUser');
        const DocName = JSON.parse(storedDocName);
        // Persist committee name locally
        try {
          const currentCommitteeName = document.getElementById('committeeName')?.textContent || '';
          if (currentCommitteeName) {
            localStorage.setItem('chairlinkCommitteeName', currentCommitteeName);
          }
        } catch (e) {
          // no-op
        }
        localStorage.setItem('chairlinkResolutions', JSON.stringify(resolutions));
        localStorage.setItem('chairlinkSpeakerList', JSON.stringify(primarySpeakerList));
        localStorage.setItem('chairlinkRecentPoints', JSON.stringify(recentPoints));
        localStorage.setItem('chairlinkSessionTime', sessionTime);
        localStorage.setItem('chairlinkSessionStartTime', sessionStartTime);
        localStorage.setItem('chairlinkSpeakerTime', speakerTime);
        localStorage.setItem('chairlinkVotingHistory', JSON.stringify(votingHistory));
        localStorage.setItem('chairlinkLoginStatus', loginStatus);
        localStorage.setItem('chairlinkCrisisMode', crisisMode);
        localStorage.setItem('chairlinkDelegateRatings', JSON.stringify(delegateRatings));
        
        // Save consolidated data for activity monitor
        try {
          const activityData = {
            delegates: delegates,
            resolutions: resolutions,
            speakerList: primarySpeakerList,
            recentPoints: recentPoints,
            sessionTime: sessionTime,
            sessionStartTime: sessionStartTime,
            votingHistory: votingHistory,
            delegateRatings: delegateRatings,
            notebook: document.getElementById('chairNotes')?.value || '',
            committeeName: document.getElementById('committeeName')?.textContent || '',
            lastActivity: Date.now()
          };
          localStorage.setItem(`chairlink_${DocName.username}`, JSON.stringify(activityData));
        } catch (e) {
          console.error('Error saving activity data:', e);
        }
        
        showNotification("Data saved successfully!");
        try {
      await db.collection("users").doc(DocName.username).set({
        chairlinkDelegates: delegates,
        chairlinkResolutions: resolutions,
        chairlinkSpeakerList: primarySpeakerList,
        chairlinkRecentPoints: recentPoints,
        chairlinkSessionTime: sessionTime,
        chairlinkSessionStartTime: sessionStartTime,
        chairlinkSpeakerTime: speakerTime,
        chairlinkVotingHistory: votingHistory,
        chairlinkCrisisMode: crisisMode,
        chairlinkDelegateRatings: delegateRatings,
        chairlinkCommitteeName: (document.getElementById('committeeName')?.textContent || ''),
        merge: true
      });

    } catch (error) {
      console.error("Error saving data:", error);
    }
    }

    async function loadData() {
      const storedDocName = localStorage.getItem('chairlinkUser');
      const DocName = JSON.parse(storedDocName);
  try {
    // Get the Firestore doc where all chairlink data lives
    const docRef = db.collection("users").doc(DocName.username);
    const docSnap = await docRef.get();

    if (docSnap.exists) {
      const data = docSnap.data();

      // Delegates
      if (data.chairlinkDelegates) {
        delegates = data.chairlinkDelegates;
        delegates.forEach(d => { 
          if (typeof d.poiCount !== 'number') d.poiCount = 0;
          if (typeof d.positionPaper !== 'boolean') d.positionPaper = false;
        });
        renderRollCallGrid();
        updateDashboardStats();
        renderDelegateRanking(); // Update ranking tab when delegates are loaded
      }

      // Resolutions
      if (data.chairlinkResolutions) {
        resolutions = data.chairlinkResolutions;
        renderResolutions();
      }

      // Speaker list
      if (data.chairlinkSpeakerList) {
        primarySpeakerList = data.chairlinkSpeakerList;
        renderSpeakerList('primary');
      }

      // Recent points
      if (data.chairlinkRecentPoints) {
        recentPoints = data.chairlinkRecentPoints;
        renderRecentPoints();
      }

      // Session time
      if (data.chairlinkSessionTime !== undefined) {
        sessionTime = parseInt(data.chairlinkSessionTime);
        updateSessionTimerDisplay();
      }
      
      // Session start time
      if (data.chairlinkSessionStartTime !== undefined) {
        sessionStartTime = parseInt(data.chairlinkSessionStartTime);
      }

      // Speaker time
      if (data.chairlinkSpeakerTime !== undefined) {
        speakerTime = parseInt(data.chairlinkSpeakerTime);
        document.getElementById('speakerTimeInput').value = speakerTime;
        document.getElementById('modSpeakerTime').value = speakerTime;
      }

      // Voting history
      if (data.chairlinkVotingHistory) {
        votingHistory = data.chairlinkVotingHistory;
        renderVotingHistory();
      }

      // Login status
      if (data.chairlinkLoginStatus) {
        loginStatus = true;
        document.getElementById('loginStatus').textContent = 'Logout';
      }

      // Crisis mode
      if (data.chairlinkCrisisMode) {
        crisisMode = true;
        document.getElementById('crisisModeBtn').classList.add('crisis-flash');
        document.getElementById('crisisModeToggle').checked = true;
      }

      // Delegate ratings
      if (data.chairlinkDelegateRatings) {
        delegateRatings = data.chairlinkDelegateRatings;
      }

      // Committee name
      if (data.chairlinkCommitteeName) {
        localStorage.setItem('chairlinkCommitteeName', data.chairlinkCommitteeName);
        const committeeNameEl = document.getElementById('committeeName');
        if (committeeNameEl) committeeNameEl.textContent = data.chairlinkCommitteeName;
      }

      showNotification("Data loaded from Firestore!");
    } else {
      console.log("No Firestore data found.");
    }
  } catch (err) {
    console.error("Error loading Firestore data:", err);
  }
  
  // Save activity data after loading to register the session
  saveActivityData();
}

    function confirmClearAllData() {
        document.getElementById('confirmationTitle').textContent = 'Clear All Data';
        document.getElementById('confirmationMessage').textContent = 'Are you sure you want to clear ALL data? This will remove all delegates, resolutions, speakers, and session data. This action cannot be undone.';
        showModal('confirmationDialog');
        document.getElementById('confirmActionBtn').onclick = () => {
            clearAllData();
        };
        document.getElementById('cancelConfirmBtn').onclick = () => closeModal('confirmationDialog');
    }

    function clearAllData() {
        // Clear all arrays and variables
        delegates = [];
        resolutions = [];
        primarySpeakerList = [];
        recentPoints = [];
        sessionTime = 0;
        speakerTime = 90;
        votingHistory = [];
        activeVoting = false;
        loginStatus = false;
        crisisMode = false;
        delegateRatings = {};
        
        // Clear localStorage but preserve login
        const user = localStorage.getItem('chairlinkUser');
        const theme = localStorage.getItem('chairlinkTheme');
        const committeeName = localStorage.getItem('chairlinkCommitteeName');
        localStorage.clear();
        if (user) localStorage.setItem('chairlinkUser', user);
        if (theme) localStorage.setItem('chairlinkTheme', theme);
        if (committeeName) localStorage.setItem('chairlinkCommitteeName', committeeName);
        
        // Update all UI components
        renderRollCallGrid();
        renderResolutions();
        renderSpeakerList('primary');
        renderRecentPoints();
        updateDashboardStats();
        renderDelegateRanking();
        updateSessionTimerDisplay();
        
        // Save the cleared state
        saveData();
        saveActivityData();
        
        showNotification('✅ All data cleared! Delegates, resolutions, and session data have been reset.', 'error');
        closeModal('confirmationDialog');
    }

    // Theme handling
    function loadTheme() {
        const savedTheme = localStorage.getItem('chairlinkTheme') || 'novamun';
        document.body.className = `font-sans theme-${savedTheme}`;
        // Apply theme classes to relevant elements if they are not body-level
        // For example, if you have a top-level div with bg-primary:
        // document.querySelector('.some-primary-bg-div').classList.add(`theme-${savedTheme}`);
        document.getElementById('themeSelector').value = savedTheme;
    }

    document.getElementById('themeSelector').addEventListener('change', (e) => {
        const selectedTheme = e.target.value;
        localStorage.setItem('chairlinkTheme', selectedTheme);
        loadTheme();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Only handle shortcuts when not in an input field
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        // Space to start/pause timer (only in caucus tab)
        if (e.key === ' ' && document.getElementById('caucus').classList.contains('hidden') === false) {
            e.preventDefault();
            if (timerInterval) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        // N for next speaker
        if (e.key === 'n' && document.getElementById('caucus').classList.contains('hidden') === false) {
            e.preventDefault();
            nextSpeaker();
        }

        // S for skip speaker
        if (e.key === 's' && document.getElementById('caucus').classList.contains('hidden') === false) {
            e.preventDefault();
            skipSpeaker();
        }

        // R for reset timer
        if (e.key === 'r' && document.getElementById('caucus').classList.contains('hidden') === false) {
            e.preventDefault();
            resetSpeakerTimer();
        }
    });

    // Initialize data loading when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
        loadTheme();
        loadNotes();
    });

    // Tab switching implementation
    const tabIds = ['dashboard','caucus','resolutions','delegateRanking'];
    let activeTab = 'dashboard';
    
    window.showTabImplementation = function(tabId) {
      console.log('🔥 TAB SWITCH TO:', tabId);
      
      tabIds.forEach(id => {
        const section = document.getElementById(id);
        const tabBtn = document.getElementById('tab-' + id);
        if (section) section.classList.add('hidden');
        if (tabBtn) {
          tabBtn.classList.remove('bg-blue-100','text-blue-900','shadow');
          tabBtn.style.background = 'transparent';
          tabBtn.style.color = '#e6f1ff';
        }
      });
      
      const targetSection = document.getElementById(tabId);
      const activeTabBtn = document.getElementById('tab-' + tabId);
      if (targetSection) targetSection.classList.remove('hidden');
      if (activeTabBtn) {
        activeTabBtn.classList.add('shadow');
        activeTabBtn.style.background = 'rgba(74, 158, 255, 0.3)';
        activeTabBtn.style.color = '#ffffff';
      }
      activeTab = tabId;
      
      // Render delegate ranking when tab is opened
      if (tabId === 'delegateRanking') {
        console.log('🔥 RANKING TAB - delegates:', delegates);
        if (typeof renderDelegateRanking === 'function') {
          renderDelegateRanking();
        } else {
          console.error('❌ renderDelegateRanking not defined yet');
        }
      }
      
      if (tabId !== 'caucus' && timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    };

    // Delegate Management
    function addDelegate(country, name, flag) {
        delegates.push({ 
            country, 
            name, 
            flag, 
            status: 'absent', 
            points: 0, 
            rating: {}, 
            poiCount: 0,
            positionPaper: false // Track position paper submission
        });
        saveData();
        saveActivityData(); // Auto-save for activity monitor
        renderRollCallGrid();
        updateDashboardStats();
        renderDelegateRanking(); // Update ranking tab when delegates are added
    }

    function renderRollCallGrid() {
        const rollCallDiv = document.getElementById('rollCall');
        rollCallDiv.innerHTML = '';
        delegates.forEach(delegate => {
            // Determine status class and color
            let statusClass = '';
            let statusLabel = '';
            let statusIndicator = '';
            
            if (delegate.status === 'present') {
                statusClass = 'status-present bg-green-50 border-green-300';
                statusLabel = 'Present';
                statusIndicator = 'status-present';
            } else if (delegate.status === 'present-voting') {
                statusClass = 'status-present-voting bg-blue-50 border-blue-300';
                statusLabel = 'P&V';
                statusIndicator = 'status-present-voting';
            } else {
                statusClass = 'status-absent bg-red-50 border-red-300';
                statusLabel = 'Absent';
                statusIndicator = 'status-absent';
            }
            
            rollCallDiv.innerHTML += `
                <div class="delegate-card ${statusIndicator} border-2 rounded-lg p-3 flex items-center shadow-md ${statusClass}">
                    ${delegate.flag ? `<img src="${delegate.flag}" alt="${delegate.country} flag" class="flag-icon mr-3 w-8 h-8">` : `<div class="w-8 h-8 mr-3 rounded-full bg-gray-300 border-2 border-gray-400"></div>`}
                    <div class="flex-1">
                        <p class="font-bold text-base" style="color: #F5DEB3;">${delegate.country}</p>
                        <p class="text-xs text-gray-600">${delegate.name}</p>
                    </div>
                    <div class="flex flex-col space-y-1">
                        <button class="action-button bg-green-600 hover:bg-green-700 text-white text-xs font-semibold px-3 py-1 rounded shadow transition" onclick="toggleDelegateStatus('${delegate.country}', 'present')">Present</button>
                        <button class="action-button bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold px-3 py-1 rounded shadow transition" onclick="toggleDelegateStatus('${delegate.country}', 'present-voting')">P&V</button>
                        <button class="action-button bg-red-600 hover:bg-red-700 text-white text-xs font-semibold px-3 py-1 rounded shadow transition" onclick="toggleDelegateStatus('${delegate.country}', 'absent')">Absent</button>
                    </div>
                </div>
            `;
        });
    }

    function toggleDelegateStatus(country, newStatus) {
        const delegateIndex = delegates.findIndex(d => d.country === country);
        if (delegateIndex !== -1) {
            delegates[delegateIndex].status = newStatus;
            saveData();
            saveActivityData(); // Auto-save for activity monitor
            renderRollCallGrid();
            updateDashboardStats();
            renderDelegateRanking(); // Update ranking display when status changes
        }
    }

    function markAllPresent() {
        delegates.forEach(d => d.status = 'present');
        saveData();
        renderRollCallGrid();
        updateDashboardStats();
        renderDelegateRanking();
    }

    function markAllPresentVoting() {
        delegates.forEach(d => d.status = 'present-voting');
        saveData();
        renderRollCallGrid();
        updateDashboardStats();
        renderDelegateRanking();
    }

    function markAllAbsent() {
        delegates.forEach(d => d.status = 'absent');
        saveData();
        renderRollCallGrid();
        updateDashboardStats();
        renderDelegateRanking();
    }

    // Country Selector for adding delegates/speakers
    let countrySelectionMode = 'delegate'; // 'delegate' or 'speaker'

    document.getElementById('addDelegateBtn').addEventListener('click', () => {
        showCountrySelector('delegate');
    });

    function showCountrySelector(mode) {
        countrySelectionMode = mode;
        document.getElementById('countrySelectorTitle').textContent = mode === 'delegate' ? 'Add Delegates' : 'Add Speakers';
        const countryListDiv = document.getElementById('countryList');
        countryListDiv.innerHTML = '';
        // Hide custom delegate area by default when opening
        const customArea = document.getElementById('customDelegateArea');
        if (customArea) customArea.classList.add('hidden');

        // Clear search input on modal open
        document.getElementById('countrySearchInput').value = '';

        // Replace the sampleCountries array in the showCountrySelector function with this:
        const sampleCountries = [
            { name: 'Afghanistan', flag: 'https://flagcdn.com/w320/af.png' },
            { name: 'Albania', flag: 'https://flagcdn.com/w320/al.png' },
            { name: 'Algeria', flag: 'https://flagcdn.com/w320/dz.png' },
            { name: 'Andorra', flag: 'https://flagcdn.com/w320/ad.png' },
            { name: 'Angola', flag: 'https://flagcdn.com/w320/ao.png' },
            { name: 'Antigua and Barbuda', flag: 'https://flagcdn.com/w320/ag.png' },
            { name: 'Argentina', flag: 'https://flagcdn.com/w320/ar.png' },
            { name: 'Armenia', flag: 'https://flagcdn.com/w320/am.png' },
            { name: 'Australia', flag: 'https://flagcdn.com/w320/au.png' },
            { name: 'Austria', flag: 'https://flagcdn.com/w320/at.png' },
            { name: 'Azerbaijan', flag: 'https://flagcdn.com/w320/az.png' },
            { name: 'Bahamas', flag: 'https://flagcdn.com/w320/bs.png' },
            { name: 'Bahrain', flag: 'https://flagcdn.com/w320/bh.png' },
            { name: 'Bangladesh', flag: 'https://flagcdn.com/w320/bd.png' },
            { name: 'Barbados', flag: 'https://flagcdn.com/w320/bb.png' },
            { name: 'Belarus', flag: 'https://flagcdn.com/w320/by.png' },
            { name: 'Belgium', flag: 'https://flagcdn.com/w320/be.png' },
            { name: 'Belize', flag: 'https://flagcdn.com/w320/bz.png' },
            { name: 'Benin', flag: 'https://flagcdn.com/w320/bj.png' },
            { name: 'Bhutan', flag: 'https://flagcdn.com/w320/bt.png' },
            { name: 'Bolivia', flag: 'https://flagcdn.com/w320/bo.png' },
            { name: 'Bosnia and Herzegovina', flag: 'https://flagcdn.com/w320/ba.png' },
            { name: 'Botswana', flag: 'https://flagcdn.com/w320/bw.png' },
            { name: 'Brazil', flag: 'https://flagcdn.com/w320/br.png' },
            { name: 'Brunei', flag: 'https://flagcdn.com/w320/bn.png' },
            { name: 'Bulgaria', flag: 'https://flagcdn.com/w320/bg.png' },
            { name: 'Burkina Faso', flag: 'https://flagcdn.com/w320/bf.png' },
            { name: 'Burundi', flag: 'https://flagcdn.com/w320/bi.png' },
            { name: 'Cabo Verde', flag: 'https://flagcdn.com/w320/cv.png' },
            { name: 'Cambodia', flag: 'https://flagcdn.com/w320/kh.png' },
            { name: 'Cameroon', flag: 'https://flagcdn.com/w320/cm.png' },
            { name: 'Canada', flag: 'https://flagcdn.com/w320/ca.png' },
            { name: 'Central African Republic', flag: 'https://flagcdn.com/w320/cf.png' },
            { name: 'Chad', flag: 'https://flagcdn.com/w320/td.png' },
            { name: 'Chile', flag: 'https://flagcdn.com/w320/cl.png' },
            { name: 'China', flag: 'https://flagcdn.com/w320/cn.png' },
            { name: 'Colombia', flag: 'https://flagcdn.com/w320/co.png' },
            { name: 'Comoros', flag: 'https://flagcdn.com/w320/km.png' },
            { name: 'Congo (Congo-Brazzaville)', flag: 'https://flagcdn.com/w320/cg.png' },
            { name: 'Costa Rica', flag: 'https://flagcdn.com/w320/cr.png' },
            { name: 'Croatia', flag: 'https://flagcdn.com/w320/hr.png' },
            { name: 'Cuba', flag: 'https://flagcdn.com/w320/cu.png' },
            { name: 'Cyprus', flag: 'https://flagcdn.com/w320/cy.png' },
            { name: 'Czechia', flag: 'https://flagcdn.com/w320/cz.png' },
            { name: 'Democratic Republic of the Congo', flag: 'https://flagcdn.com/w320/cd.png' },
            { name: 'Denmark', flag: 'https://flagcdn.com/w320/dk.png' },
            { name: 'Djibouti', flag: 'https://flagcdn.com/w320/dj.png' },
            { name: 'Dominica', flag: 'https://flagcdn.com/w320/dm.png' },
            { name: 'Dominican Republic', flag: 'https://flagcdn.com/w320/do.png' },
            { name: 'Ecuador', flag: 'https://flagcdn.com/w320/ec.png' },
            { name: 'Egypt', flag: 'https://flagcdn.com/w320/eg.png' },
            { name: 'El Salvador', flag: 'https://flagcdn.com/w320/sv.png' },
            { name: 'Equatorial Guinea', flag: 'https://flagcdn.com/w320/gq.png' },
            { name: 'Eritrea', flag: 'https://flagcdn.com/w320/er.png' },
            { name: 'Estonia', flag: 'https://flagcdn.com/w320/ee.png' },
            { name: 'Eswatini', flag: 'https://flagcdn.com/w320/sz.png' },
            { name: 'Ethiopia', flag: 'https://flagcdn.com/w320/et.png' },
            { name: 'Fiji', flag: 'https://flagcdn.com/w320/fj.png' },
            { name: 'Finland', flag: 'https://flagcdn.com/w320/fi.png' },
            { name: 'France', flag: 'https://flagcdn.com/w320/fr.png' },
            { name: 'Gabon', flag: 'https://flagcdn.com/w320/ga.png' },
            { name: 'Gambia', flag: 'https://flagcdn.com/w320/gm.png' },
            { name: 'Georgia', flag: 'https://flagcdn.com/w320/ge.png' },
            { name: 'Germany', flag: 'https://flagcdn.com/w320/de.png' },
            { name: 'Ghana', flag: 'https://flagcdn.com/w320/gh.png' },
            { name: 'Greece', flag: 'https://flagcdn.com/w320/gr.png' },
            { name: 'Grenada', flag: 'https://flagcdn.com/w320/gd.png' },
            { name: 'Guatemala', flag: 'https://flagcdn.com/w320/gt.png' },
            { name: 'Guinea', flag: 'https://flagcdn.com/w320/gn.png' },
            { name: 'Guinea-Bissau', flag: 'https://flagcdn.com/w320/gw.png' },
            { name: 'Guyana', flag: 'https://flagcdn.com/w320/gy.png' },
            { name: 'Haiti', flag: 'https://flagcdn.com/w320/ht.png' },
            { name: 'Honduras', flag: 'https://flagcdn.com/w320/hn.png' },
            { name: 'Hungary', flag: 'https://flagcdn.com/w320/hu.png' },
            { name: 'Iceland', flag: 'https://flagcdn.com/w320/is.png' },
            { name: 'India', flag: 'https://flagcdn.com/w320/in.png' },
            { name: 'Indonesia', flag: 'https://flagcdn.com/w320/id.png' },
            { name: 'Iran', flag: 'https://flagcdn.com/w320/ir.png' },
            { name: 'Iraq', flag: 'https://flagcdn.com/w320/iq.png' },
            { name: 'Ireland', flag: 'https://flagcdn.com/w320/ie.png' },
            
            { name: 'Italy', flag: 'https://flagcdn.com/w320/it.png' },
            { name: 'Jamaica', flag: 'https://flagcdn.com/w320/jm.png' },
            { name: 'Japan', flag: 'https://flagcdn.com/w320/jp.png' },
            { name: 'Jordan', flag: 'https://flagcdn.com/w320/jo.png' },
            { name: 'Kazakhstan', flag: 'https://flagcdn.com/w320/kz.png' },
            { name: 'Kenya', flag: 'https://flagcdn.com/w320/ke.png' },
            { name: 'Kiribati', flag: 'https://flagcdn.com/w320/ki.png' },
            { name: 'Kuwait', flag: 'https://flagcdn.com/w320/kw.png' },
            { name: 'Kyrgyzstan', flag: 'https://flagcdn.com/w320/kg.png' },
            { name: 'Laos', flag: 'https://flagcdn.com/w320/la.png' },
            { name: 'Latvia', flag: 'https://flagcdn.com/w320/lv.png' },
            { name: 'Lebanon', flag: 'https://flagcdn.com/w320/lb.png' },
            { name: 'Lesotho', flag: 'https://flagcdn.com/w320/ls.png' },
            { name: 'Liberia', flag: 'https://flagcdn.com/w320/lr.png' },
            { name: 'Libya', flag: 'https://flagcdn.com/w320/ly.png' },
            { name: 'Liechtenstein', flag: 'https://flagcdn.com/w320/li.png' },
            { name: 'Lithuania', flag: 'https://flagcdn.com/w320/lt.png' },
            { name: 'Luxembourg', flag: 'https://flagcdn.com/w320/lu.png' },
            { name: 'Madagascar', flag: 'https://flagcdn.com/w320/mg.png' },
            { name: 'Malawi', flag: 'https://flagcdn.com/w320/mw.png' },
            { name: 'Malaysia', flag: 'https://flagcdn.com/w320/my.png' },
            { name: 'Maldives', flag: 'https://flagcdn.com/w320/mv.png' },
            { name: 'Mali', flag: 'https://flagcdn.com/w320/ml.png' },
            { name: 'Malta', flag: 'https://flagcdn.com/w320/mt.png' },
            { name: 'Marshall Islands', flag: 'https://flagcdn.com/w320/mh.png' },
            { name: 'Mauritania', flag: 'https://flagcdn.com/w320/mr.png' },
            { name: 'Mauritius', flag: 'https://flagcdn.com/w320/mu.png' },
            { name: 'Mexico', flag: 'https://flagcdn.com/w320/mx.png' },
            { name: 'Micronesia', flag: 'https://flagcdn.com/w320/fm.png' },
            { name: 'Moldova', flag: 'https://flagcdn.com/w320/md.png' },
            { name: 'Monaco', flag: 'https://flagcdn.com/w320/mc.png' },
            { name: 'Mongolia', flag: 'https://flagcdn.com/w320/mn.png' },
            { name: 'Montenegro', flag: 'https://flagcdn.com/w320/me.png' },
            { name: 'Morocco', flag: 'https://flagcdn.com/w320/ma.png' },
            { name: 'Mozambique', flag: 'https://flagcdn.com/w320/mz.png' },
            { name: 'Myanmar', flag: 'https://flagcdn.com/w320/mm.png' },
            { name: 'Namibia', flag: 'https://flagcdn.com/w320/na.png' },
            { name: 'Nauru', flag: 'https://flagcdn.com/w320/nr.png' },
            { name: 'Nepal', flag: 'https://flagcdn.com/w320/np.png' },
            { name: 'Netherlands', flag: 'https://flagcdn.com/w320/nl.png' },
            { name: 'New Zealand', flag: 'https://flagcdn.com/w320/nz.png' },
            { name: 'Nicaragua', flag: 'https://flagcdn.com/w320/ni.png' },
            { name: 'Niger', flag: 'https://flagcdn.com/w320/ne.png' },
            { name: 'Nigeria', flag: 'https://flagcdn.com/w320/ng.png' },
            { name: 'North Korea', flag: 'https://flagcdn.com/w320/kp.png' },
            { name: 'North Macedonia', flag: 'https://flagcdn.com/w320/mk.png' },
            { name: 'Norway', flag: 'https://flagcdn.com/w320/no.png' },
            { name: 'Oman', flag: 'https://flagcdn.com/w320/om.png' },
            { name: 'Pakistan', flag: 'https://flagcdn.com/w320/pk.png' },
            { name: 'Palau', flag: 'https://flagcdn.com/w320/pw.png' },
            { name: 'Palestine', flag: 'https://flagcdn.com/w320/ps.png' },
            { name: 'Panama', flag: 'https://flagcdn.com/w320/pa.png' },
            { name: 'Papua New Guinea', flag: 'https://flagcdn.com/w320/pg.png' },
            { name: 'Paraguay', flag: 'https://flagcdn.com/w320/py.png' },
            { name: 'Peru', flag: 'https://flagcdn.com/w320/pe.png' },
            { name: 'Philippines', flag: 'https://flagcdn.com/w320/ph.png' },
            { name: 'Poland', flag: 'https://flagcdn.com/w320/pl.png' },
            { name: 'Portugal', flag: 'https://flagcdn.com/w320/pt.png' },
            { name: 'Qatar', flag: 'https://flagcdn.com/w320/qa.png' },
            { name: 'Romania', flag: 'https://flagcdn.com/w320/ro.png' },
            { name: 'Russia', flag: 'https://flagcdn.com/w320/ru.png' },
            { name: 'Rwanda', flag: 'https://flagcdn.com/w320/rw.png' },
            { name: 'Saint Kitts and Nevis', flag: 'https://flagcdn.com/w320/kn.png' },
            { name: 'Saint Lucia', flag: 'https://flagcdn.com/w320/lc.png' },
            { name: 'Saint Vincent and the Grenadines', flag: 'https://flagcdn.com/w320/vc.png' },
            { name: 'Samoa', flag: 'https://flagcdn.com/w320/ws.png' },
            { name: 'San Marino', flag: 'https://flagcdn.com/w320/sm.png' },
            { name: 'Sao Tome and Principe', flag: 'https://flagcdn.com/w320/st.png' },
            { name: 'Saudi Arabia', flag: 'https://flagcdn.com/w320/sa.png' },
            { name: 'Senegal', flag: 'https://flagcdn.com/w320/sn.png' },
            { name: 'Serbia', flag: 'https://flagcdn.com/w320/rs.png' },
            { name: 'Seychelles', flag: 'https://flagcdn.com/w320/sc.png' },
            { name: 'Sierra Leone', flag: 'https://flagcdn.com/w320/sl.png' },
            { name: 'Singapore', flag: 'https://flagcdn.com/w320/sg.png' },
            { name: 'Slovakia', flag: 'https://flagcdn.com/w320/sk.png' },
            { name: 'Slovenia', flag: 'https://flagcdn.com/w320/si.png' },
            { name: 'Solomon Islands', flag: 'https://flagcdn.com/w320/sb.png' },
            { name: 'Somalia', flag: 'https://flagcdn.com/w320/so.png' },
            { name: 'South Africa', flag: 'https://flagcdn.com/w320/za.png' },
            { name: 'South Korea', flag: 'https://flagcdn.com/w320/kr.png' },
            { name: 'South Sudan', flag: 'https://flagcdn.com/w320/ss.png' },
            { name: 'Spain', flag: 'https://flagcdn.com/w320/es.png' },
            { name: 'Sri Lanka', flag: 'https://flagcdn.com/w320/lk.png' },
            { name: 'Sudan', flag: 'https://flagcdn.com/w320/sd.png' },
            { name: 'Suriname', flag: 'https://flagcdn.com/w320/sr.png' },
            { name: 'Sweden', flag: 'https://flagcdn.com/w320/se.png' },
            { name: 'Switzerland', flag: 'https://flagcdn.com/w320/ch.png' },
            { name: 'Syria', flag: 'https://flagcdn.com/w320/sy.png' },
            { name: 'Tajikistan', flag: 'https://flagcdn.com/w320/tj.png' },
            { name: 'Tanzania', flag: 'https://flagcdn.com/w320/tz.png' },
            { name: 'Thailand', flag: 'https://flagcdn.com/w320/th.png' },
            { name: 'Timor-Leste', flag: 'https://flagcdn.com/w320/tl.png' },
            { name: 'Togo', flag: 'https://flagcdn.com/w320/tg.png' },
            { name: 'Tonga', flag: 'https://flagcdn.com/w320/to.png' },
            { name: 'Trinidad and Tobago', flag: 'https://flagcdn.com/w320/tt.png' },
            { name: 'Tunisia', flag: 'https://flagcdn.com/w320/tn.png' },
            { name: 'Turkey', flag: 'https://flagcdn.com/w320/tr.png' },
            { name: 'Turkmenistan', flag: 'https://flagcdn.com/w320/tm.png' },
            { name: 'Tuvalu', flag: 'https://flagcdn.com/w320/tv.png' },
            { name: 'Uganda', flag: 'https://flagcdn.com/w320/ug.png' },
            { name: 'Ukraine', flag: 'https://flagcdn.com/w320/ua.png' },
            { name: 'United Arab Emirates', flag: 'https://flagcdn.com/w320/ae.png' },
            { name: 'United Kingdom', flag: 'https://flagcdn.com/w320/gb.png' },
            { name: 'United States', flag: 'https://flagcdn.com/w320/us.png' },
            { name: 'Uruguay', flag: 'https://flagcdn.com/w320/uy.png' },
            { name: 'Uzbekistan', flag: 'https://flagcdn.com/w320/uz.png' },
            { name: 'Vanuatu', flag: 'https://flagcdn.com/w320/vu.png' },
            { name: 'Vatican City', flag: 'https://flagcdn.com/w320/va.png' },
            { name: 'Venezuela', flag: 'https://flagcdn.com/w320/ve.png' },
            { name: 'Vietnam', flag: 'https://flagcdn.com/w320/vn.png' },
            { name: 'Yemen', flag: 'https://flagcdn.com/w320/ye.png' },
            { name: 'Zambia', flag: 'https://flagcdn.com/w320/zm.png' },
            { name: 'Zimbabwe', flag: 'https://flagcdn.com/w320/zw.png' }
        ];

        // Build list source based on mode
        let sourceList = [];
        if (mode === 'delegate') {
            // All possible countries for adding delegates (filter out ones already added)
            sourceList = sampleCountries
                .filter(c => !delegates.some(d => d.country === c.name))
                .map(c => ({ name: c.name, flag: c.flag }));
        } else if (mode === 'speaker') {
            // Only already-added delegates (not yet in the speaker list)
            sourceList = delegates
                .filter(d => !primarySpeakerList.some(s => s.sCountry === d.country))
                .map(d => ({ name: d.country, flag: d.flag || '' }));
        }

        sourceList.forEach(item => {
            const countryName = item.name;
            const flagUrl = item.flag;
            countryListDiv.innerHTML += `
                <div class="country-item">
                    <input type="checkbox" id="country-${countryName.replace(/\s/g, '-')}" value="${countryName}" data-flag="${flagUrl}" onchange="updateSelectionCount()">
                    <label for="country-${countryName.replace(/\s/g, '-')}" class="flex items-center flex-1 ml-2 cursor-pointer">
                        ${flagUrl ? `<img src="${flagUrl}" alt="${countryName} flag" class="w-6 h-6 mr-3 rounded-full object-cover border border-gray-200">` : `<div class=\"w-6 h-6 mr-3 rounded-full bg-gray-300 border border-gray-200\"></div>`}
                        ${countryName}
                    </label>
                </div>
            `;
        });

        showModal('countrySelectorModal');
        updateSelectionCount(); // Initialize count to 0
    }

    // Select/Deselect All Countries
    function selectAllCountries() {
        const checkboxes = document.querySelectorAll('#countryList input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            const item = checkbox.closest('.country-item');
            if (item && item.style.display !== 'none') {
                checkbox.checked = true;
            }
        });
        updateSelectionCount();
    }
    
    function deselectAllCountries() {
        const checkboxes = document.querySelectorAll('#countryList input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectionCount();
    }
    
    function updateSelectionCount() {
        const selectedCount = document.querySelectorAll('#countryList input[type="checkbox"]:checked').length;
        const countDisplay = document.getElementById('selectionCount');
        if (countDisplay) {
            countDisplay.textContent = `${selectedCount} selected`;
            if (selectedCount > 0) {
                countDisplay.classList.remove('text-gray-600');
                countDisplay.classList.add('text-blue-600', 'font-semibold');
            } else {
                countDisplay.classList.add('text-gray-600');
                countDisplay.classList.remove('text-blue-600', 'font-semibold');
            }
        }
    }

    document.getElementById('countrySearchInput').addEventListener('keyup', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('#countryList .country-item').forEach(item => {
            const countryName = item.querySelector('label').textContent.toLowerCase();
            if (countryName.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });

    document.getElementById('addSelectedCountriesBtn').addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('#countryList input[type="checkbox"]:checked');
        if (selectedCheckboxes.length === 0) {
            showNotification('Please select at least one country.', 'warning');
            return;
        }

        let addedCount = 0;
        
        if (countrySelectionMode === 'delegate') {
            // Batch add all delegates at once
            selectedCheckboxes.forEach(checkbox => {
                const countryName = checkbox.value;
                const flagUrl = checkbox.dataset.flag;
                const existingDelegate = delegates.find(d => d.country === countryName);
                if (!existingDelegate) {
                    // Add to delegates array without calling saveData yet
                    delegates.push({ 
                        country: countryName, 
                        name: countryName, 
                        flag: flagUrl, 
                        status: 'absent', 
                        points: 0, 
                        rating: {}, 
                        poiCount: 0,
                        positionPaper: false
                    });
                    addedCount++;
                }
            });
            
            // Now save and update UI once for all delegates
            if (addedCount > 0) {
                saveData();
                saveActivityData();
                renderRollCallGrid();
                updateDashboardStats();
                renderDelegateRanking();
            }
        } else if (countrySelectionMode === 'speaker') {
            // Add speakers one by one (less common, so keep original logic)
            selectedCheckboxes.forEach(checkbox => {
                const countryName = checkbox.value;
                const existingSpeaker = primarySpeakerList.find(s => s.sCountry === countryName);
                if (!existingSpeaker) {
                    addSpeakerToPrimaryList(countryName);
                    addedCount++;
                }
            });
        }
        
        closeModal('countrySelectorModal');
        
        if (addedCount > 0) {
            showNotification(`${addedCount} ${countrySelectionMode === 'delegate' ? 'delegate(s)' : 'speaker(s)'} added!`, 'success');
        } else {
            showNotification('All selected countries already exist.', 'info');
        }
    });

    // Toggle custom delegate area inside country selector
    document.getElementById('toggleCustomDelegateArea').addEventListener('click', function() {
        const area = document.getElementById('customDelegateArea');
        area.classList.toggle('hidden');
    });

    // Add custom delegates by comma-separated names
    document.getElementById('addCustomDelegatesBtn').addEventListener('click', async function() {
        const textarea = document.getElementById('customDelegateNames');
        const raw = (textarea.value || '').trim();
        if (!raw) {
            showNotification('Please enter at least one name.', 'warning');
            return;
        }
        
        // Split by comma and trim each name
        const names = raw.split(',').map(n => n.trim()).filter(n => n.length > 0);
        
        if (names.length === 0) {
            showNotification('Please enter valid names separated by commas.', 'warning');
            return;
        }
        
        console.log('📝 Custom delegates to add:', names);
        showNotification(`Adding ${names.length} custom delegate(s)... Please wait.`, 'info');
        
        let addedCount = 0;
        
        // Batch add all custom delegates
        for (const name of names) {
            const existing = delegates.find(d => d.country === name);
            if (!existing) {
                // Fetch image for the delegate (optional, can be skipped for speed)
                let imageUrl = '';
                try {
                    imageUrl = await fetchImageForName(name);
                    await new Promise(r => setTimeout(r, 100)); // Small delay for API
                } catch (e) {
                    console.log(`Could not fetch image for ${name}`);
                }
                
                // Add directly to delegates array (batch mode)
                delegates.push({ 
                    country: name, 
                    name: name, 
                    flag: imageUrl || '', 
                    status: 'absent', 
                    points: 0, 
                    rating: {}, 
                    poiCount: 0,
                    positionPaper: false
                });
                addedCount++;
                console.log(`✅ Added: ${name}`);
            } else {
                console.log(`⚠️ Skipped (already exists): ${name}`);
            }
        }
        
        if (addedCount > 0) {
            // Save and update UI once for all delegates
            saveData();
            saveActivityData();
            renderRollCallGrid();
            updateDashboardStats();
            renderDelegateRanking();
            
            showNotification(`✅ ${addedCount} custom delegate(s) added successfully!`, 'success');
            textarea.value = '';
            closeModal('countrySelectorModal');
        } else {
            showNotification('All entered names already exist as delegates.', 'info');
        }
    });

    // Auto-save activity data every 5 seconds for real-time monitoring
    setInterval(saveActivityData, 5000);
    
    // Session Timer and Current Speaker Timer (Existing functions, simplified for brevity)
    function startSessionTimer() {
        if (sessionTimerInterval) clearInterval(sessionTimerInterval);
        sessionTimerInterval = setInterval(() => {
            sessionTime++;
            updateSessionTimerDisplay();
        }, 1000);
    }
    function updateSessionTimerDisplay() {
        const hours = String(Math.floor(sessionTime / 3600)).padStart(2, '0');
        const minutes = String(Math.floor((sessionTime % 3600) / 60)).padStart(2, '0');
        const seconds = String(sessionTime % 60).padStart(2, '0');
        document.getElementById('sessionTimer').textContent = `${hours}:${minutes}:${seconds}`;
    }
    let timerMilliseconds = 0;
    
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        if (currentSpeakerSeconds <= 0 && primarySpeakerList.length > 0) {
            currentSpeakerSeconds = speakerTime; // Reset to default if timer finished
        }
        if (currentSpeakerSeconds > 0) {
            timerMilliseconds = currentSpeakerSeconds * 1000;
            
            timerInterval = setInterval(() => {
                if (timerMilliseconds > 0) {
                    timerMilliseconds -= 100; // Decrease by 100ms
                    currentSpeakerSeconds = Math.ceil(timerMilliseconds / 1000);
                    
                    const totalSeconds = Math.floor(timerMilliseconds / 1000);
                    const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                    const seconds = String(totalSeconds % 60).padStart(2, '0');
                    document.getElementById('timer').textContent = `${minutes}:${seconds}`;
                } else {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    timerMilliseconds = 0;
                    currentSpeakerSeconds = 0;
                    document.getElementById('timer').textContent = '00:00';
                    showNotification('Speaker time ended!', 'warning');
                }
            }, 100); // Update every 100ms for smooth countdown
            
            const minutes = String(Math.floor(currentSpeakerSeconds / 60)).padStart(2, '0');
            const seconds = String(currentSpeakerSeconds % 60).padStart(2, '0');
            document.getElementById('currentSpeakerTime').textContent = `${minutes}:${seconds}`;
        }
    }
    function pauseTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            showNotification('Timer paused.', 'warning');
        }
    }
    function resetSpeakerTimer() {
        clearInterval(timerInterval);
        timerInterval = null;
        currentSpeakerSeconds = speakerTime;
        timerMilliseconds = currentSpeakerSeconds * 1000;
        const minutes = String(Math.floor(currentSpeakerSeconds / 60)).padStart(2, '0');
        const seconds = String(currentSpeakerSeconds % 60).padStart(2, '0');
        document.getElementById('timer').textContent = `${minutes}:${seconds}`;
        document.getElementById('currentSpeakerTime').textContent = `${minutes}:${seconds}`;
        showNotification('Speaker timer reset.', 'info');
    }
    function adjustTime(seconds) {
        currentSpeakerSeconds = Math.max(0, currentSpeakerSeconds + seconds);
        timerMilliseconds = currentSpeakerSeconds * 1000;
        const minutes = String(Math.floor(currentSpeakerSeconds / 60)).padStart(2, '0');
        const secs = String(currentSpeakerSeconds % 60).padStart(2, '0');
        document.getElementById('timer').textContent = `${minutes}:${secs}`;
        document.getElementById('currentSpeakerTime').textContent = `${minutes}:${secs}`;
    }

    // Speaker List Management
    function addSpeakerToPrimaryList(country) {
        if (!primarySpeakerList.some(s => s.sCountry === country)) {
            primarySpeakerList.push({ sCountry: country, timeSpoken: 0 });
            saveData();
            renderSpeakerList('primary');
            showNotification(`${country} added to speaker list.`, 'info');
        } else {
            showNotification(`${country} is already in the speaker list.`, 'warning');
        }
    }

    function removeSpeaker(country, listType) {
        if (listType === 'primary') {
            primarySpeakerList = primarySpeakerList.filter(s => s.sCountry !== country);
        }
        saveData();
        renderSpeakerList(listType);
        updateDashboardStats();
    }

    function nextSpeaker() {
        pauseTimer(); // Pause current timer if running
        if (primarySpeakerList.length > 0) {
            const currentSpeaker = primarySpeakerList.shift(); // Remove current speaker from top
            // You might want to save currentSpeaker's timeSpoken here
            primarySpeakerList.push(currentSpeaker); // Add to end of list
            saveData();
            renderSpeakerList('primary');
            updateCurrentSpeakerDisplay();
            resetSpeakerTimer(); // Reset timer for the new speaker
            showNotification('Next speaker in line.', 'info');
        } else {
            showNotification('Speaker list is empty!', 'warning');
            document.getElementById('currentSpeaker').textContent = 'No speaker';
            document.getElementById('currentSpeakerCountry').textContent = '-';
            resetSpeakerTimer();
        }
    }

    function skipSpeaker() {
        pauseTimer();
        if (primarySpeakerList.length > 0) {
            primarySpeakerList.shift(); // Simply remove the current speaker
            saveData();
            renderSpeakerList('primary');
            updateCurrentSpeakerDisplay();
            resetSpeakerTimer();
            showNotification('Current speaker skipped.', 'info');
        } else {
            showNotification('Speaker list is empty!', 'warning');
        }
    }

    function renderSpeakerList(listType) {
        const listDiv = document.getElementById('primarySpeakerList');
        listDiv.innerHTML = '';
        if (primarySpeakerList.length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500 italic">No speakers in list.</p>';
        } else {
            primarySpeakerList.forEach((speaker, index) => {
                // Find the delegate to get their flag
                const delegate = delegates.find(d => d.country === speaker.sCountry);
                const flagUrl = delegate ? delegate.flag : '';
                
                listDiv.innerHTML += `
                    <div class="speaker-item flex items-center justify-between p-3 bg-white rounded-lg border-2 border-gray-300 shadow-sm hover:shadow-md transition cursor-move" 
                         draggable="true" 
                         data-index="${index}"
                         ondragstart="handleDragStart(event, ${index})"
                         ondragover="handleDragOver(event)"
                         ondrop="handleDrop(event, ${index})"
                         ondragend="handleDragEnd(event)">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-blue-600 text-lg">${index + 1}.</span>
                            ${flagUrl ? `<img src="${flagUrl}" alt="${speaker.sCountry}" class="w-8 h-8 rounded-full object-cover border-2 border-gray-200">` : `<div class="w-8 h-8 rounded-full bg-gray-300 border-2 border-gray-400"></div>`}
                            <span class="font-semibold text-base" style="color: #F5DEB3;">${speaker.sCountry}</span>
                        </div>
                        <button class="text-red-500 hover:text-red-700 text-xl transition" onclick="removeSpeaker('${speaker.sCountry}', '${listType}')">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>
                `;
            });
        }
        updateCurrentSpeakerDisplay();
    }
    
    // Drag and Drop functionality
    let draggedIndex = null;
    
    function handleDragStart(event, index) {
        draggedIndex = index;
        event.currentTarget.style.opacity = '0.5';
    }
    
    function handleDragOver(event) {
        event.preventDefault();
        return false;
    }
    
    function handleDrop(event, dropIndex) {
        event.preventDefault();
        if (draggedIndex !== null && draggedIndex !== dropIndex) {
            // Reorder the array
            const item = primarySpeakerList.splice(draggedIndex, 1)[0];
            primarySpeakerList.splice(dropIndex, 0, item);
            saveData();
            renderSpeakerList('primary');
            showNotification('Speaker order updated', 'success');
        }
        return false;
    }
    
    function handleDragEnd(event) {
        event.currentTarget.style.opacity = '1';
        draggedIndex = null;
    }

    function randomizeSpeakerList(listType) {
        if (listType === 'primary') {
            for (let i = primarySpeakerList.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [primarySpeakerList[i], primarySpeakerList[j]] = [primarySpeakerList[j], primarySpeakerList[i]];
            }
        }
        saveData();
        renderSpeakerList(listType);
        showNotification('Speaker list randomized!', 'info');
    }

    function confirmClearSpeakerList(listType) {
        document.getElementById('confirmationTitle').textContent = 'Clear Speaker List';
        document.getElementById('confirmationMessage').textContent = `Are you sure you want to clear the ${listType} speaker list? This action cannot be undone.`;
        showModal('confirmationDialog');
        document.getElementById('confirmActionBtn').onclick = () => {
            if (listType === 'primary') {
                primarySpeakerList = [];
            }
            saveData();
            renderSpeakerList(listType);
            updateCurrentSpeakerDisplay();
            showNotification('Speaker list cleared!', 'error');
            closeModal('confirmationDialog');
        };
        document.getElementById('cancelConfirmBtn').onclick = () => closeModal('confirmationDialog');
    }

    function updateCurrentSpeakerDisplay() {
        if (primarySpeakerList.length > 0) {
            document.getElementById('currentSpeaker').textContent = primarySpeakerList[0].sCountry;
            document.getElementById('currentSpeakerCountry').innerHTML = `
                <img src="${delegates.find(d => d.country === primarySpeakerList[0].sCountry)?.flag || ''}"
                     alt="${primarySpeakerList[0].sCountry} flag" class="w-5 h-5 rounded-full object-cover mr-2 border border-gray-200">
                ${primarySpeakerList[0].sCountry}
            `;
        } else {
            document.getElementById('currentSpeaker').textContent = 'No speaker';
            document.getElementById('currentSpeakerCountry').textContent = '-';
        }
    }

    function updateDashboardStats() {
        document.getElementById('totalDelegates').textContent = delegates.length;
        document.getElementById('presentDelegates').textContent = delegates.filter(d => d.status === 'present').length;
        document.getElementById('votingDelegates').textContent = delegates.filter(d => d.status === 'present-voting').length;
        document.getElementById('absentDelegates').textContent = delegates.filter(d => d.status === 'absent').length;
    }

    // Remove Delegate Flow
    function showRemoveDelegateModal() {
        const listDiv = document.getElementById('removeDelegateList');
        const search = document.getElementById('removeDelegateSearch');
        listDiv.innerHTML = '';
        search.value = '';
        delegates.forEach(d => {
            const id = `del-${d.country.replace(/\s/g,'-')}`;
            listDiv.innerHTML += `
                <div class="country-item">
                    <input type="checkbox" id="${id}" value="${d.country}">
                    <label for="${id}" class="flex items-center flex-1 ml-2 cursor-pointer">
                        ${d.flag ? `<img src="${d.flag}" class=\"w-6 h-6 mr-3 rounded-full object-cover border border-gray-200\">` : `<div class=\"w-6 h-6 mr-3 rounded-full bg-gray-300 border border-gray-200\"></div>`}
                        <span class="font-medium">${d.country}</span>
                        <span class="ml-2 text-gray-500 text-sm">(${d.name})</span>
                    </label>
                </div>
            `;
        });
        showModal('removeDelegateModal');
    }

    document.getElementById('removeDelegateSearch').addEventListener('keyup', function(e) {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('#removeDelegateList .country-item').forEach(item => {
            const txt = item.textContent.toLowerCase();
            item.style.display = txt.includes(term) ? 'flex' : 'none';
        });
    });

    document.getElementById('confirmRemoveDelegatesBtn').addEventListener('click', function() {
        const selected = Array.from(document.querySelectorAll('#removeDelegateList input[type="checkbox"]:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            showNotification('Please select at least one delegate to remove.', 'warning');
            return;
        }
        // Remove from delegates
        delegates = delegates.filter(d => !selected.includes(d.country));
        // Also clean speaker list entries for removed delegates
        primarySpeakerList = primarySpeakerList.filter(s => !selected.includes(s.sCountry));
        saveData();
        renderRollCallGrid();
        renderSpeakerList('primary');
        updateDashboardStats();
        renderDelegateRanking();
        closeModal('removeDelegateModal');
        showNotification('Selected delegates removed.', 'error');
    });

    // Points and Motions
    function addPointOfOrder() {
        const timestamp = new Date().toLocaleTimeString();
        recentPoints.unshift({ type: 'Point of Order', timestamp: timestamp });
        saveData();
        renderRecentPoints();
        showNotification('Point of Order added.', 'info');
    }

    function addMotion() {
        const topic = document.getElementById('motionTopic').value;
        const duration = document.getElementById('motionDuration').value;
        const durationUnit = document.getElementById('motionDurationUnit').value;
        const speakerTimeMotion = document.getElementById('motionSpeakerTime').value;

        if (!topic) {
            showNotification('Motion topic cannot be empty.', 'error');
            return;
        }

        const timestamp = new Date().toLocaleTimeString();
        recentPoints.unshift({
            type: 'Motion',
            topic,
            duration: duration ? `${duration} ${durationUnit}` : 'N/A',
            speakerTime: speakerTimeMotion ? `${speakerTimeMotion} seconds` : 'N/A',
            timestamp: timestamp
        });
        saveData();
        renderRecentPoints();
        showNotification('Motion proposed.', 'success');
        closeModal('quickMotionPopup');
        document.getElementById('motionTopic').value = '';
        document.getElementById('motionDuration').value = '';
        document.getElementById('motionSpeakerTime').value = '';
    }

    function renderRecentPoints() {
        const recentPointsDiv = document.getElementById('recentPoints');
        recentPointsDiv.innerHTML = '';
        if (recentPoints.length === 0) {
            recentPointsDiv.innerHTML = '<p class="text-gray-500 italic">No recent points or motions.</p>';
            return;
        }
        recentPoints.forEach(point => {
            let content = '';
            if (point.type === 'Point of Order') {
                content = `<span>${point.type}</span> at ${point.timestamp}`;
            } else if (point.type === 'Motion') {
                content = `<span>Motion:</span> ${point.topic} (Duration: ${point.duration}, Speaker Time: ${point.speakerTime}) at ${point.timestamp}`;
            } else if (point.type === 'POI') {
                content = `<span>POI:</span> ${point.question} (${point.target}) by ${point.delegate} at ${point.timestamp}`;
            }
            recentPointsDiv.innerHTML += `<div class="border-b border-gray-200 pb-1 mb-1">${content}</div>`;
        });
    }

    function confirmClearRecentPoints() {
        document.getElementById('confirmationTitle').textContent = 'Clear Recent Points & Motions';
        document.getElementById('confirmationMessage').textContent = 'Are you sure you want to clear all recent points and motions? This action cannot be undone.';
        showModal('confirmationDialog');
        document.getElementById('confirmActionBtn').onclick = () => {
            recentPoints = [];
            saveData();
            renderRecentPoints();
            showNotification('Recent points and motions cleared!', 'error');
            closeModal('confirmationDialog');
        };
        document.getElementById('cancelConfirmBtn').onclick = () => closeModal('confirmationDialog');
    }

    function showQuickMotionPopup() {
        showModal('quickMotionPopup');
    }

    function addPOI() {
        const question = document.getElementById('poiQuestion').value.trim();
        const target = document.getElementById('poiTarget').value;
        // Placeholder for delegate who raised POI - in a real app, this would be selected
        const delegateRaisingPOI = primarySpeakerList.length > 0 ? primarySpeakerList[0].sCountry : 'Unknown Delegate';

        if (!question) {
            showNotification('POI question cannot be empty.', 'error');
            return;
        }

        const timestamp = new Date().toLocaleTimeString();
        recentPoints.unshift({ type: 'POI', question: question, target: target, delegate: delegateRaisingPOI, timestamp: timestamp });
        saveData();
        renderRecentPoints();
        showNotification('Point of Information added.', 'info');
        document.getElementById('poiQuestion').value = ''; // Clear input
    }


    // Notebook
    function saveNote() {
        localStorage.setItem('chairlinkNotes', document.getElementById('notebookText').value);
        showNotification('Notes saved!', 'success');
    }

    function loadNotes() {
        document.getElementById('notebookText').value = localStorage.getItem('chairlinkNotes') || '';
    }

    function insertTimestamp() {
        const textarea = document.getElementById('notebookText');
        const now = new Date();
        const timestamp = `[${now.toLocaleDateString()} ${now.toLocaleTimeString()}] `;
        const start = textarea.selectionStart;
        textarea.value = textarea.value.substring(0, start) + timestamp + textarea.value.substring(textarea.selectionEnd, textarea.value.length);
        textarea.selectionStart = start + timestamp.length;
        textarea.selectionEnd = start + timestamp.length;
        showNotification('Timestamp inserted.', 'info');
    }

    function exportNotes() {
        const text = document.getElementById('notebookText').value;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'chairlink_notes.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification('Notes exported as .txt', 'success');
    }


    // Resolutions
    let currentResolutionId = null;

    function showResolutionPopup(resolution = null) {
        document.getElementById('resolutionTitle').value = '';
        document.getElementById('resolutionTopic').value = '';
        document.getElementById('resolutionStatus').value = 'draft';
        currentResolutionId = null;

        if (resolution) {
            document.getElementById('resolutionPopupTitle').textContent = 'Edit Resolution';
            document.getElementById('resolutionTitle').value = resolution.title;
            document.getElementById('resolutionTopic').value = resolution.topic;
            document.getElementById('resolutionStatus').value = resolution.status;
            currentResolutionId = resolution.id;
        } else {
            document.getElementById('resolutionPopupTitle').textContent = 'New Resolution';
        }
        showModal('resolutionPopup');
    }

    function saveResolution() {
        const title = document.getElementById('resolutionTitle').value.trim();
        const topic = document.getElementById('resolutionTopic').value.trim();
        const status = document.getElementById('resolutionStatus').value;

        if (!title || !topic) {
            showNotification('Resolution title and topic cannot be empty.', 'error');
            return;
        }

        if (currentResolutionId) {
            // Update existing resolution
            const index = resolutions.findIndex(res => res.id === currentResolutionId);
            if (index !== -1) {
                resolutions[index] = { id: currentResolutionId, title, topic, status };
                showNotification('Resolution updated!', 'success');
            }
        } else {
            // Add new resolution
            const newId = Date.now().toString(); // Simple unique ID
            resolutions.push({ id: newId, title, topic, status });
            showNotification('Resolution added!', 'success');
        }
        saveData();
        renderResolutions();
        closeModal('resolutionPopup');
    }

    function renderResolutions() {
        const resolutionListBody = document.getElementById('resolutionList');
        resolutionListBody.innerHTML = '';
        if (resolutions.length === 0) {
            resolutionListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500 italic">No resolutions added yet.</td></tr>';
            return;
        }
        resolutions.forEach(res => {
            const statusClass = res.status === 'passed' ? 'text-green-600' : res.status === 'failed' ? 'text-red-600' : 'text-gray-600';
            resolutionListBody.innerHTML += `
                <tr class="border-b last:border-b-0">
                    <td class="py-3 px-4 font-medium">${res.title}</td>
                    <td class="py-3 px-4 text-gray-700">${res.topic}</td>
                    <td class="py-3 px-4"><span class="${statusClass} font-semibold">${res.status.charAt(0).toUpperCase() + res.status.slice(1)}</span></td>
                    <td class="py-3 px-4">
                        <div class="flex gap-2">
                            <button class="text-blue-500 hover:text-blue-700 text-lg" onclick="showResolutionPopup(${JSON.stringify(res).replace(/"/g, '&quot;')})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700 text-lg" onclick="deleteResolution('${res.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    function deleteResolution(id) {
        document.getElementById('confirmationTitle').textContent = 'Delete Resolution';
        document.getElementById('confirmationMessage').textContent = 'Are you sure you want to delete this resolution? This action cannot be undone.';
        showModal('confirmationDialog');
        document.getElementById('confirmActionBtn').onclick = () => {
            resolutions = resolutions.filter(res => res.id !== id);
            saveData();
            renderResolutions();
            showNotification('Resolution deleted!', 'error');
            closeModal('confirmationDialog');
        };
        document.getElementById('cancelConfirmBtn').onclick = () => closeModal('confirmationDialog');
    }

    function exportResolutions() {
        const json = JSON.stringify(resolutions, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'chairlink_resolutions.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification('Resolutions exported as .json', 'success');
    }


    // Voting
    let votingTimer;
    let votingTimeRemaining;
    let votingDelegates = [];

    function startVotingProcedure() {
        document.getElementById('votingProcedureModal').querySelector('.voting-procedure').innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Start Voting Procedure</h3>
                <button class="text-gray-500 hover:text-gray-700" onclick="closeModal('votingProcedureModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label for="voteSubject" class="block text-sm font-medium text-gray-700 mb-1">Subject of Vote</label>
                <input type="text" id="voteSubject" class="compact-input w-full p-2 border rounded-md" placeholder="e.g., Motion to open debate">
            </div>
            <div class="mb-4">
                <label for="voteType" class="block text-sm font-medium text-gray-700 mb-1">Vote Type</label>
                <select id="voteType" class="compact-select w-full p-2 border rounded-md">
                    <option value="simple">Simple Majority</option>
                    <option value="two-thirds">Two-thirds Majority</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="votingDuration" class="block text-sm font-medium text-gray-700 mb-1">Voting Duration (seconds)</label>
                <input type="number" id="votingDuration" class="compact-input w-full p-2 border rounded-md" value="30">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Voting Method</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="votingMethod" value="traditional" checked class="mr-2">
                        <span>Traditional (Manual)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="votingMethod" value="digital" class="mr-2">
                        <span>Digital (QR Code/Link)</span>
                    </label>
                </div>
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="showLiveResults" class="mr-2">
                    <span class="text-sm font-medium text-gray-700">Show live results to delegates</span>
                </label>
            </div>
            <div class="flex justify-end gap-2">
                <button class="modal-button modal-button-primary" onclick="initiateVoting()">Start Vote</button>
            </div>
        `;
        showModal('votingProcedureModal');
    }

    function initiateVoting() {
        activeVoteSubject = document.getElementById('voteSubject').value.trim();
        activeVoteType = document.getElementById('voteType').value;
        votingTimeRemaining = parseInt(document.getElementById('votingDuration').value);
        const votingMethod = document.querySelector('input[name="votingMethod"]:checked').value;
        const showLiveResults = document.getElementById('showLiveResults').checked;

        if (!activeVoteSubject) {
            showNotification('Please enter a subject for the vote.', 'error');
            return;
        }
        if (isNaN(votingTimeRemaining) || votingTimeRemaining <= 0) {
            showNotification('Please enter a valid voting duration.', 'error');
            return;
        }

        yesVotes = 0;
        noVotes = 0;
        abstainVotes = 0;
        presentVotes = 0;
        totalVotes = delegates.filter(d => d.status === 'present' || d.status === 'present-voting').length;
        votingDelegates = delegates.filter(d => d.status === 'present' || d.status === 'present-voting').map(d => ({
            country: d.country,
            status: d.status,
            vote: 'undecided'
        }));

        // Generate unique session ID for this vote
        const sessionId = Date.now().toString();
        activeVoteSessionId = sessionId;

        if (votingMethod === 'digital') {
            // Create digital voting session
            const voteData = {
                id: sessionId,
                subject: activeVoteSubject,
                type: activeVoteType,
                duration: votingTimeRemaining,
                showResults: showLiveResults,
                timestamp: new Date().toISOString()
            };

            // Store vote data for delegate access
            localStorage.setItem(`chairlink_vote_${sessionId}`, JSON.stringify(voteData));

            // Show QR code and links modal
            showDigitalVotingModal(sessionId);
        } else {
            // Traditional voting
            document.getElementById('activeVoteSubject').textContent = activeVoteSubject;
            document.getElementById('activeVotingDisplay').classList.remove('hidden');
            closeModal('votingProcedureModal');
            showNotification('Traditional voting started!', 'info');

            updateVotingDisplay();
            votingTimer = setInterval(() => {
                votingTimeRemaining--;
                updateVotingDisplay();
                if (votingTimeRemaining <= 0) {
                    endVoting();
                }
            }, 1000);
        }
    }

    function updateVotingDisplay() {
        document.getElementById('yesVotes').textContent = yesVotes;
        document.getElementById('noVotes').textContent = noVotes;
        document.getElementById('abstainVotes').textContent = abstainVotes;
        document.getElementById('presentVotes').textContent = presentVotes;

        const progress = (totalVotes === 0) ? 100 : ((yesVotes + noVotes + abstainVotes + presentVotes) / totalVotes) * 100;
        document.getElementById('votingProgress').style.width = `${progress}%`;

        document.getElementById('votingTimeLeft').textContent = `${votingTimeRemaining}s`;
    }

    function recordVote(country, vote) {
        const delegateIndex = votingDelegates.findIndex(d => d.country === country);
        if (delegateIndex !== -1 && votingDelegates[delegateIndex].vote === 'undecided') {
            votingDelegates[delegateIndex].vote = vote;
            if (vote === 'yes') yesVotes++;
            else if (vote === 'no') noVotes++;
            else if (vote === 'abstain') abstainVotes++;
            else if (vote === 'present') presentVotes++; // for present but not voting

            updateVotingDisplay();
            showNotification(`${country} voted ${vote}.`, 'info');
        } else if (delegateIndex === -1) {
            showNotification(`${country} is not eligible to vote.`, 'error');
        } else {
            showNotification(`${country} has already voted.`, 'warning');
        }
    }

    function endVoting() {
        clearInterval(votingTimer);
        document.getElementById('activeVotingDisplay').classList.add('hidden');

        // Calculate result
        let result = 'Failed';
        let majorityNeeded = 0;

        const totalValidVotes = yesVotes + noVotes + abstainVotes; // Votes that count towards majority
        const totalPresentVoting = delegates.filter(d => d.status === 'present-voting').length;

        if (activeVoteType === 'simple') {
            majorityNeeded = Math.floor(totalValidVotes / 2) + 1;
        } else if (activeVoteType === 'two-thirds') {
            majorityNeeded = Math.ceil((yesVotes + noVotes) * (2/3)); // Two-thirds of votes cast (yes/no)
        }

        // Simplified majority logic for "present and voting"
        if (yesVotes >= majorityNeeded) {
            result = 'Passed';
        } else if (yesVotes > noVotes && activeVoteType === 'simple' && yesVotes > majorityNeeded) {
             result = 'Passed (Simple Majority)';
        } else if (yesVotes > (noVotes * 2) && activeVoteType === 'two-thirds' && yesVotes > majorityNeeded) {
             result = 'Passed (Two-thirds Majority)';
        } else {
             result = 'Failed';
        }

        votingHistory.unshift({
            subject: activeVoteSubject,
            type: activeVoteType,
            result: result,
            yes: yesVotes,
            no: noVotes,
            abstain: abstainVotes,
            present: presentVotes,
            timestamp: new Date().toLocaleString()
        });
        saveData();
        renderVotingHistory();
        showNotification(`Voting ended! Result: ${result}`, result === 'Passed' ? 'success' : 'error');
        totalVotes++; // Increment overall vote count
        updateDashboardStats();
    }

    function closeVotingDisplay() {
        clearInterval(votingTimer);
        document.getElementById('activeVotingDisplay').classList.add('hidden');
        showNotification('Voting display closed.', 'info');
    }

    function renderVotingHistory() {
        const historyBody = document.getElementById('votingHistory');
        historyBody.innerHTML = '';
        if (votingHistory.length === 0) {
            historyBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500 italic">No voting history.</td></tr>';
            return;
        }
        votingHistory.forEach(vote => {
            const resultClass = vote.result.includes('Passed') ? 'text-green-600' : 'text-red-600';
            historyBody.innerHTML += `
                <tr class="border-b last:border-b-0">
                    <td class="py-3 px-4 font-medium">${vote.subject}</td>
                    <td class="py-3 px-4 text-gray-700">${vote.type}</td>
                    <td class="py-3 px-4"><span class="${resultClass} font-semibold">${vote.result}</span></td>
                    <td class="py-3 px-4 text-sm">
                        Yes: ${vote.yes}, No: ${vote.no}, Abstain: ${vote.abstain}<br>
                        Present: ${vote.present}
                        <span class="block text-xs text-gray-500">${vote.timestamp}</span>
                    </td>
                </tr>
            `;
        });
    }

    function startRollCallVote() {
        // This would typically iterate through delegates for individual voting
        showNotification('Roll Call Voting initiated. Manually record votes for each delegate.', 'info');
        // Example: You would present a list of delegates with Yes/No/Abstain buttons
        // For demonstration, we'll just show the active voting display with a note
        startVotingProcedure(); // Reuse the voting procedure setup, but with a note
        document.getElementById('voteSubject').value = 'Roll Call Vote';
        document.getElementById('voteType').value = 'simple';
        document.getElementById('votingDuration').value = '60';
        document.getElementById('votingProcedureModal').querySelector('.voting-procedure').innerHTML += `
            <p class="text-sm text-gray-600 mt-4">For a true roll call, you'd call out each country and use the 'recordVote' function manually or integrate an interactive delegate vote input.</p>
        `;
    }

    function startShowOfHands() {
        showNotification('Show of Hands Voting initiated. Count votes manually.', 'info');
        // This is primarily for manual counting by the chair
        startVotingProcedure(); // Reuse the voting procedure setup, but with a note
        document.getElementById('voteSubject').value = 'Show of Hands Vote';
        document.getElementById('voteType').value = 'simple';
        document.getElementById('votingDuration').value = '15';
        document.getElementById('votingProcedureModal').querySelector('.voting-procedure').innerHTML += `
            <p class="text-sm text-gray-600 mt-4">Count 'Yes', 'No', and 'Abstain' votes visually and enter them below or use manual 'recordVote' for summary.</p>
            <div class="mt-4 flex gap-2">
                <input type="number" id="manualYes" placeholder="Yes" class="compact-input w-20">
                <input type="number" id="manualNo" placeholder="No" class="compact-input w-20">
                <input type="number" id="manualAbstain" placeholder="Abstain" class="compact-input w-20">
                <button class="action-button bg-blue-500 text-white" onclick="manualRecordShowOfHands()">Record Counts</button>
            </div>
        `;
    }

    function manualRecordShowOfHands() {
        yesVotes = parseInt(document.getElementById('manualYes').value) || 0;
        noVotes = parseInt(document.getElementById('manualNo').value) || 0;
        abstainVotes = parseInt(document.getElementById('manualAbstain').value) || 0;
        presentVotes = delegates.filter(d => d.status === 'present' || d.status === 'present-voting').length - (yesVotes + noVotes + abstainVotes);
        updateVotingDisplay();
        showNotification('Manual vote counts updated.', 'success');
    }

    // Login
    function performLogin() {
        // Simplified for client-side demo; in production, this would involve server-side auth
        const username = document.getElementById('usernameInput').value;
        const password = document.getElementById('passwordInput').value;

        if (username === 'chair' && password === 'pass') {
            loginStatus = true;
            document.getElementById('loginStatus').textContent = 'Logout';
            showNotification('Login successful!', 'success');
            closeModal('loginModal');
            saveData();
        } else {
            showNotification('Invalid username or password.', 'error');
        }
    }

    function performLogout() {
        loginStatus = false;
        document.getElementById('loginStatus').textContent = 'Login';
        showNotification('Logged out.', 'info');
        saveData();
    }

    document.getElementById('loginBtn').addEventListener('click', () => {
        if (loginStatus) {
            performLogout();
        } else {
            showModal('loginModal');
        }
    });


    // Settings
    document.addEventListener('DOMContentLoaded', function() {
        const settingsBtnEl = document.getElementById('settingsBtn');
        if (settingsBtnEl) {
            settingsBtnEl.addEventListener('click', openSettings);
        }
    });

    // ===== CHAIR TOOLS & SETTINGS =====
    function openChairSettings() {
        // Load current values
        const committeeNameEl = document.getElementById('committeeName');
        if (committeeNameEl) {
            document.getElementById('committeeNameInput').value = committeeNameEl.textContent || '';
        }
        document.getElementById('speakerTimeInput').value = speakerTime;
        document.getElementById('crisisModeToggle').checked = crisisMode;
        
        showModal('settingsModal');
    }

    function applySettings() {
        const newCommitteeName = document.getElementById('committeeNameInput').value.trim();
        const newSpeakerTime = parseInt(document.getElementById('speakerTimeInput').value);
        const newCrisisMode = document.getElementById('crisisModeToggle').checked;

        // Update committee name
        if (newCommitteeName) {
            const committeeNameEl = document.getElementById('committeeName');
            if (committeeNameEl) {
                committeeNameEl.textContent = newCommitteeName;
            }
            localStorage.setItem('chairlinkCommitteeName', newCommitteeName);
        }

        // Update speaker time
        if (!isNaN(newSpeakerTime) && newSpeakerTime > 0) {
            speakerTime = newSpeakerTime;
            const modSpeakerTimeEl = document.getElementById('modSpeakerTime');
            if (modSpeakerTimeEl) {
                modSpeakerTimeEl.value = speakerTime;
            }
        }

        // Update crisis mode
        if (newCrisisMode !== crisisMode) {
            crisisMode = newCrisisMode;
            if (crisisMode) {
                showNotification('⚠️ Crisis Mode Activated!', 'error');
            } else {
                showNotification('✅ Crisis Mode Deactivated', 'success');
            }
        }

        saveData();
        showNotification('✅ Settings Applied Successfully!', 'success');
        closeModal('settingsModal');
    }
    
    function changeTheme(themeName) {
        localStorage.setItem('chairlinkTheme', themeName);
        document.body.className = `font-sans theme-${themeName}`;
        const themeSelector = document.getElementById('themeSelector');
        if (themeSelector) {
            themeSelector.value = themeName;
        }
        showNotification(`Theme changed to ${themeName}`, 'success');
    }
    
    function resetSessionTimer() {
        if (confirm('Reset session timer to 00:00:00?')) {
            sessionTime = 0;
            updateSessionTimerDisplay();
            showNotification('Session timer reset!', 'info');
        }
    }

    document.getElementById('importFileInput').addEventListener('change', importData);

    function importData(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.delegates) delegates = importedData.delegates;
                    if (importedData.resolutions) resolutions = importedData.resolutions;
                    if (importedData.primarySpeakerList) primarySpeakerList = importedData.primarySpeakerList;
                    if (importedData.recentPoints) recentPoints = importedData.recentPoints;
                    if (importedData.sessionTime) sessionTime = importedData.sessionTime;
                    if (importedData.speakerTime) speakerTime = importedData.speakerTime;
                    if (importedData.votingHistory) votingHistory = importedData.votingHistory;
                    if (importedData.loginStatus) loginStatus = importedData.loginStatus;
                    if (importedData.crisisMode) crisisMode = importedData.crisisMode;
                    if (importedData.delegateRatings) delegateRatings = importedData.delegateRatings;

                    saveData(); // Save imported data to localStorage
                    loadData(); // Re-render all elements
                    showNotification('Data imported successfully!', 'success');
                } catch (error) {
                    showNotification('Error importing data. Invalid JSON file.', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }
    }

    document.getElementById('committeeLogo').addEventListener('click', () => document.getElementById('uploadLogoInput').click());
    document.getElementById('uploadLogoBtn').addEventListener('click', () => document.getElementById('uploadLogoInput').click());

    // Add a hidden file input for logo upload
    const logoInput = document.createElement('input');
    logoInput.type = 'file';
    logoInput.accept = 'image/*';
    logoInput.id = 'uploadLogoInput';
    logoInput.style.display = 'none';
    document.body.appendChild(logoInput);

    logoInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('committeeLogo').src = e.target.result;
                localStorage.setItem('chairlinkLogo', e.target.result);
                showNotification('Logo updated!', 'success');
            };
            reader.readAsDataURL(file);
        }
    });

    // Load logo on startup
    document.addEventListener('DOMContentLoaded', () => {
        const savedLogo = localStorage.getItem('chairlinkLogo');
        if (savedLogo) {
            document.getElementById('committeeLogo').src = savedLogo;
        }
        // Also ensure committee name is loaded on startup
        document.getElementById('committeeName').textContent = localStorage.getItem('chairlinkCommitteeName') || 'General Assembly';
    });


    // Crisis Mode
    document.getElementById('crisisModeBtn').addEventListener('click', () => {
        crisisMode = !crisisMode;
        if (crisisMode) {
            document.getElementById('crisisModeBtn').classList.add('crisis-flash');
            showNotification('Crisis Mode Activated!', 'error');
        } else {
            document.getElementById('crisisModeBtn').classList.remove('crisis-flash');
            showNotification('Crisis Mode Deactivated.', 'success');
        }
        document.getElementById('crisisModeToggle').checked = crisisMode;
        saveData();
    });



    // ===== DELEGATE RANKING SYSTEM =====
    function renderDelegateRanking() {
      console.log('🔍 RENDER CALLED');
      console.log('📊 Delegates array:', delegates);
      console.log('📊 Number of delegates:', delegates ? delegates.length : 0);
      
      const grid = document.getElementById('delegateRankingGrid');
      const emptyState = document.getElementById('rankingEmptyState');
      
      console.log('🎯 Grid element:', grid);
      console.log('🎯 Empty state:', emptyState);
      
      if (!delegates || delegates.length === 0) {
        console.log('❌ NO DELEGATES - showing empty state');
        if (grid) grid.innerHTML = '';
        if (emptyState) emptyState.classList.remove('hidden');
        return;
      }
      
      console.log('✅ DELEGATES FOUND - rendering...');
      if (emptyState) emptyState.classList.add('hidden');
      
      // Filter delegates based on search
      const searchTerm = document.getElementById('rankingSearch') ? document.getElementById('rankingSearch').value.toLowerCase() : '';
      let filteredDelegates = delegates.filter(d => 
        d.country.toLowerCase().includes(searchTerm) || 
        d.name.toLowerCase().includes(searchTerm)
      );
      
      // Sort delegates by total points
      filteredDelegates.sort((a, b) => {
        const pointsA = calculateDelegatePoints(a);
        const pointsB = calculateDelegatePoints(b);
        return pointsB - pointsA; // Highest points first
      });
      
      // Render delegate cards
      grid.innerHTML = filteredDelegates.map(delegate => {
        const ratings = delegateRatings[delegate.country] || {};
        const totalPoints = calculateDelegatePoints(delegate);
        
        // Generate star ratings for each criterion
        let criteriaHTML = rankingCriteria.map(criterion => {
          const rating = ratings[criterion] || 0;
          const stars = [1, 2, 3, 4, 5].map(star => 
            `<i class="fas fa-star cursor-pointer ${star <= rating ? 'text-yellow-400' : 'text-gray-300'}" 
                onclick="setCriterionRating('${delegate.country}', '${criterion}', ${star})" 
                style="font-size: 1.25rem;"></i>`
          ).join(' ');
          
          return `
            <div class="mb-2">
              <label class="block text-sm font-medium mb-1 ranking-label">${criterion}</label>
              <div class="flex gap-1">${stars}</div>
            </div>
          `;
        }).join('');
        
        return `
          <div class="border-2 rounded-lg p-4 shadow-md ranking-card hover:shadow-lg transition">
            <div class="flex items-center gap-3 mb-3">
              ${delegate.flag ? `<img src="${delegate.flag}" alt="${delegate.country}" class="w-12 h-12 rounded-full object-cover border-2 border-gray-200">` : `<div class="w-12 h-12 rounded-full bg-gray-300 border-2 border-gray-400"></div>`}
              <div class="flex-1">
                <h3 class="font-bold text-base ranking-title" style="color: #F5DEB3;">${delegate.country}</h3>
                <p class="text-xs ranking-subtitle">${delegate.name}</p>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold ranking-points">${totalPoints}</div>
                <div class="text-xs ranking-label">Points</div>
              </div>
            </div>
            
            ${criteriaHTML}
            
            <div class="flex items-center justify-between mt-3 pt-3 border-t ranking-border">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" ${delegate.positionPaper ? 'checked' : ''} 
                  onchange="togglePositionPaper('${delegate.country}')" 
                  class="w-4 h-4 text-blue-600 rounded">
                <span class="text-sm font-medium ranking-label">Position Paper Submitted?</span>
              </label>
            </div>
            
            <div class="flex items-center justify-between mt-2">
              <span class="text-sm font-medium ranking-label">POI's</span>
              <div class="flex items-center gap-2">
                <button class="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600" 
                  onclick="adjustPOI('${delegate.country}', -1)">-</button>
                <span class="font-semibold text-base ranking-text">${delegate.poiCount || 0}</span>
                <button class="px-2 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600" 
                  onclick="adjustPOI('${delegate.country}', 1)">+</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      console.log('✅ RENDERING COMPLETE');
      console.log('📦 HTML length:', grid.innerHTML.length);
    }
    
    function calculateDelegatePoints(delegate) {
      let points = 0;
      
      // Add points from criteria ratings
      const ratings = delegateRatings[delegate.country] || {};
      rankingCriteria.forEach(criterion => {
        points += (ratings[criterion] || 0);
      });
      
      // Add points from POIs (1 point each)
      points += (delegate.poiCount || 0);
      
      // Add points from position paper (5 points)
      if (delegate.positionPaper) {
        points += 5;
      }
      
      return points;
    }
    
    function setCriterionRating(country, criterion, rating) {
      if (!delegateRatings[country]) {
        delegateRatings[country] = {};
      }
      delegateRatings[country][criterion] = rating;
      saveData();
      renderDelegateRanking();
      showNotification(`${country} - ${criterion}: ${rating} stars`, 'success');
    }
    
    function togglePositionPaper(country) {
      const delegate = delegates.find(d => d.country === country);
      if (delegate) {
        delegate.positionPaper = !delegate.positionPaper;
        saveData();
        renderDelegateRanking();
        showNotification(`${country} position paper ${delegate.positionPaper ? 'submitted' : 'removed'}`, 'info');
      }
    }
    
    function adjustPOI(country, change) {
      const delegate = delegates.find(d => d.country === country);
      if (delegate) {
        delegate.poiCount = Math.max(0, (delegate.poiCount || 0) + change);
        saveData();
        renderDelegateRanking();
      }
    }
    
    
    // Event listeners for ranking tab - wrapped to ensure elements exist
    document.addEventListener('DOMContentLoaded', function() {
      const rankingSearch = document.getElementById('rankingSearch');
      
      if (rankingSearch) {
        rankingSearch.addEventListener('input', renderDelegateRanking);
      }
    });

    document.getElementById('exportDataBtn').addEventListener('click', function() {
      const data = {
        delegates,
        resolutions,
        primarySpeakerList,
        recentPoints,
        sessionTime,
        speakerTime,
        votingHistory,
        loginStatus,
        crisisMode,
        delegateRatings
      };
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'chairlink_data.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification('Data exported as .json', 'success');
    });

    document.getElementById('importFileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importedData = JSON.parse(e.target.result);
            if (importedData.delegates) delegates = importedData.delegates;
            if (importedData.resolutions) resolutions = importedData.resolutions;
            if (importedData.primarySpeakerList) primarySpeakerList = importedData.primarySpeakerList;
            if (importedData.recentPoints) recentPoints = importedData.recentPoints;
            if (importedData.sessionTime) sessionTime = importedData.sessionTime;
            if (importedData.speakerTime) speakerTime = importedData.speakerTime;
            if (importedData.votingHistory) votingHistory = importedData.votingHistory;
            if (importedData.loginStatus) loginStatus = importedData.loginStatus;
            if (importedData.crisisMode) crisisMode = importedData.crisisMode;
            if (importedData.delegateRatings) delegateRatings = importedData.delegateRatings;
            saveData();
            loadData();
            showNotification('Data imported successfully!', 'success');
          } catch (error) {
            showNotification('Error importing data. Invalid JSON file.', 'error');
            console.error('Import error:', error);
          }
        };
        reader.readAsText(file);
      }
    });

    // Digital Voting Functions
    function showDigitalVotingModal(sessionId) {
        closeModal('votingProcedureModal');

        // Generate QR code
        generateQRCode(sessionId);

        // Generate voting links
        generateVotingLinks(sessionId);

        // Start polling for results
        startDigitalVotingPolling(sessionId);

        showModal('digitalVotingModal');
        showNotification('Digital voting session created! Share the QR code or links with delegates.', 'success');
    }

    function generateQRCode(sessionId) {
        // Handle both local file and web server scenarios
        let baseUrl;
        if (window.location.protocol === 'file:') {
            // For local files, use relative path
            baseUrl = 'delegate-voting.html';
        } else {
            // For web servers, use full URL
            baseUrl = window.location.origin + window.location.pathname.replace('chairlink add settings nd crisismun nd novamun n empower.html', 'delegate-voting.html');
        }

        const masterUrl = `${baseUrl}?session=${sessionId}&delegate=all`;

        const qrContainer = document.getElementById('qrCodeContainer');
        qrContainer.innerHTML = '';

        // Generate QR code using the QR library
        QRCode.toCanvas(qrContainer, masterUrl, {
            width: 200,
            margin: 2,
            color: {
                dark: '#000000',
                light: '#FFFFFF'
            }
        }, function (error, canvas) {
            if (error) {
                console.error('QR Code generation error:', error);
                // Fallback to simple canvas
                const fallbackCanvas = document.createElement('canvas');
                fallbackCanvas.width = 200;
                fallbackCanvas.height = 200;
                const ctx = fallbackCanvas.getContext('2d');
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 200, 200);
                ctx.fillStyle = '#fff';
                ctx.fillRect(10, 10, 180, 180);
                ctx.fillStyle = '#000';
                ctx.fillRect(20, 20, 160, 160);
                ctx.fillStyle = '#000';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Scan to Vote', 100, 190);
                qrContainer.appendChild(fallbackCanvas);
                window.qrCanvas = fallbackCanvas;
            } else {
                window.qrCanvas = canvas;
            }
        });
    }

    function generateVotingLinks(sessionId) {
        // Handle both local file and web server scenarios
        let baseUrl;
        if (window.location.protocol === 'file:') {
            // For local files, use relative path
            baseUrl = 'delegate-voting.html';
        } else {
            // For web servers, use full URL
            baseUrl = window.location.origin + window.location.pathname.replace('chairlink add settings nd crisismun nd novamun n empower.html', 'delegate-voting.html');
        }

        // Master link
        const masterUrl = `${baseUrl}?session=${sessionId}&delegate=all`;
        document.getElementById('masterVotingLink').value = masterUrl;

        // Individual links
        const individualContainer = document.getElementById('individualLinksContainer');
        individualContainer.innerHTML = '';

        delegates.forEach(delegate => {
            const individualUrl = `${baseUrl}?session=${sessionId}&delegate=${encodeURIComponent(delegate.country)}`;
            const linkDiv = document.createElement('div');
            linkDiv.className = 'flex items-center gap-2 p-2 bg-gray-50 rounded';
            linkDiv.innerHTML = `
                <span class="text-sm font-medium text-gray-700 flex-shrink-0">${delegate.country}:</span>
                <input type="text" value="${individualUrl}" class="flex-1 p-1 text-xs border rounded" readonly>
                <button class="action-button bg-blue-500 text-white px-2 py-1 text-xs" onclick="copyToClipboard(this.previousElementSibling)">
                    <i class="fas fa-copy"></i>
                </button>
            `;
            individualContainer.appendChild(linkDiv);
        });

        // Update total votes count
        document.getElementById('digitalTotalVotes').textContent = delegates.filter(d => d.status === 'present' || d.status === 'present-voting').length;
    }

    function copyToClipboard(element) {
        if (typeof element === 'string') {
            element = document.getElementById(element);
        }
        element.select();
        element.setSelectionRange(0, 99999);
        document.execCommand('copy');
        showNotification('Link copied to clipboard!', 'success');
    }

    function downloadQRCode() {
        if (window.qrCanvas) {
            const link = document.createElement('a');
            link.download = 'chairlink-voting-qr.png';
            link.href = window.qrCanvas.toDataURL();
            link.click();
        }
    }

    function startDigitalVotingPolling(sessionId) {
        if (digitalVotingInterval) {
            clearInterval(digitalVotingInterval);
        }

        digitalVotingInterval = setInterval(() => {
            updateDigitalVotingResults(sessionId);
        }, 2000);
    }

    function updateDigitalVotingResults(sessionId) {
        try {
            const votes = JSON.parse(localStorage.getItem(`chairlink_votes_${sessionId}`) || '[]');
            const yesCount = votes.filter(v => v.vote === 'yes').length;
            const abstainCount = votes.filter(v => v.vote === 'abstain').length;
            const noCount = votes.filter(v => v.vote === 'no').length;
            const totalVoted = votes.length;
            const totalEligible = delegates.filter(d => d.status === 'present' || d.status === 'present-voting').length;

            document.getElementById('digitalYesVotes').textContent = yesCount;
            document.getElementById('digitalAbstainVotes').textContent = abstainCount;
            document.getElementById('digitalNoVotes').textContent = noCount;
            document.getElementById('digitalVoteProgress').textContent = totalVoted;
            document.getElementById('digitalTotalVotes').textContent = totalEligible;

            // Update the main voting display if it's open
            if (!document.getElementById('activeVotingDisplay').classList.contains('hidden')) {
                yesVotes = yesCount;
                noVotes = noCount;
                abstainVotes = abstainCount;
                updateVotingDisplay();
            }
        } catch (error) {
            console.error('Error updating digital voting results:', error);
        }
    }

    function refreshDigitalResults() {
        if (activeVoteSessionId) {
            updateDigitalVotingResults(activeVoteSessionId);
            showNotification('Results refreshed!', 'success');
        }
    }

    function endDigitalVoting() {
        if (digitalVotingInterval) {
            clearInterval(digitalVotingInterval);
            digitalVotingInterval = null;
        }

        closeModal('digitalVotingModal');

        // Calculate final results
        const votes = JSON.parse(localStorage.getItem(`chairlink_votes_${activeVoteSessionId}`) || '[]');
        yesVotes = votes.filter(v => v.vote === 'yes').length;
        noVotes = votes.filter(v => v.vote === 'no').length;
        abstainVotes = votes.filter(v => v.vote === 'abstain').length;
        presentVotes = 0; // Digital voting doesn't have "present but not voting"

        // Calculate result
        let result = 'Failed';
        const totalValidVotes = yesVotes + noVotes + abstainVotes;

        if (activeVoteType === 'simple') {
            const majorityNeeded = Math.floor(totalValidVotes / 2) + 1;
            if (yesVotes >= majorityNeeded) {
                result = 'Passed';
            }
        } else if (activeVoteType === 'two-thirds') {
            const majorityNeeded = Math.ceil((yesVotes + noVotes) * (2/3));
            if (yesVotes >= majorityNeeded) {
                result = 'Passed (Two-thirds Majority)';
            }
        }

        // Add to voting history
        votingHistory.unshift({
            subject: activeVoteSubject,
            type: activeVoteType,
            result: result,
            yes: yesVotes,
            no: noVotes,
            abstain: abstainVotes,
            present: presentVotes,
            timestamp: new Date().toLocaleString(),
            method: 'Digital'
        });

        saveData();
        renderVotingHistory();
        showNotification(`Digital voting ended! Result: ${result}`, result.includes('Passed') ? 'success' : 'error');

        // Clean up
        localStorage.removeItem(`chairlink_vote_${activeVoteSessionId}`);
        activeVoteSessionId = null;
    }

    // Always start with login screen, even if localStorage is set
    window.addEventListener('DOMContentLoaded', function() {
      localStorage.removeItem('chairlinkUser');
      document.getElementById('loginOverlay').style.display = 'flex';
      document.body.classList.add('overflow-hidden');
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('iconBar').style.display = 'none';
      document.getElementById('loadingOverlay').style.display = 'none';
    });

    // Show icon bar after loading
    setTimeout(() => {
      document.getElementById('iconBar').style.display = '';
    }, 3140);

    // Theme icon spin and menu logic
    let themeMenuOpen = false;
    document.getElementById('themeIconBtn').addEventListener('click', function() {
      this.classList.add('animate-spin-fast');
      setTimeout(() => this.classList.remove('animate-spin-fast'), 600);
      // Show/hide theme menu (implement your menu logic here)
      // ...
    });

    // Logout icon logic
    document.getElementById('logoutIconBtn').addEventListener('click', function() {
      logout();
    });

    // Confetti on logo click
    function sprayConfetti() {
      // Use a confetti library or custom canvas confetti here
      // Example: confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }
    document.getElementById('committeeLogo').addEventListener('click', sprayConfetti);
    document.querySelector('#loadingOverlay img').addEventListener('click', sprayConfetti);

    // Loading blue line animation with ease-in-out
    // (Replace SVG animateTransform with JS/CSS animation for custom timing)
    // ... existing code ...
</script>
<script>
const allowedUsers = [
  { username: "Khaled", password: "Khaled@chairlinkfounder" },
  { username: "Omar", password: "Omar@chairlinkfounder" },
  { username: "SentiaChair", password: "SentiaxChairlink" },
  { username: "FutureChair", password: "FuturexChairlink" },
  { username: "UnityChair", password: "UnityxChairlink" },
  { username: "ChairLink", password: "ChairLink123@" },
  { username: "ChairlinkGuest1", password: "GuestChair1" },
  { username: "ChairlinkGuest2", password: "GuestChair2" },
  { username: "ChairlinkGuest3", password: "GuestChair3" },
  { username: "ChairlinkGuest4", password: "GuestChair4" },
  { username: "ChairlinkGuest5", password: "GuestChair5" },
  { username: "ChairlinkGuest6", password: "GuestChair6" },
  { username: "ChairlinkGuest7", password: "GuestChair7" },
  { username: "ChairlinkGuest8", password: "GuestChair8" },
  { username: "ChairlinkGuest9", password: "GuestChair9" },
  { username: "ChairlinkGuest10", password: "GuestChair10" },
  // NOVAMUN Committee Credentials (2 chairs per committee)
  { username: "UNSC1", password: "UNSC1" },
  { username: "UNSC2", password: "UNSC2" },
  { username: "UNHRC1", password: "UNHRC1" },
  { username: "UNHRC2", password: "UNHRC2" },
  { username: "ICC1", password: "ICC1" },
  { username: "ICC2", password: "ICC2" },
  { username: "HSC1", password: "HSC1" },
  { username: "HSC2", password: "HSC2" },
  { username: "ADHOC1", password: "ADHOC1" },
  { username: "ADHOC2", password: "ADHOC2" },
  { username: "CRISIS1", password: "CRISIS1" },
  { username: "CRISIS2", password: "CRISIS2" },
  { username: "UNOOSA1", password: "UNOOSA1" },
  { username: "UNOOSA2", password: "UNOOSA2" },
  { username: "UNICEF1", password: "UNICEF1" },
  { username: "UNICEF2", password: "UNICEF2" },
  { username: "WHO1", password: "WHO1" },
  { username: "WHO2", password: "WHO2" }
];

// Map usernames to full committee names
function getFullCommitteeName(username) {
  if (!username) return localStorage.getItem('chairlinkCommitteeName') || 'General Assembly';
  const u = String(username).toUpperCase();
  // NOVAMUN Committee mapping
  if (u.startsWith('UNSC')) return 'United Nations Security Council (UNSC)';
  if (u.startsWith('UNHRC')) return 'United Nations Human Rights Council (UNHRC)';
  if (u.startsWith('ICC')) return 'International Criminal Court (ICC)';
  if (u.startsWith('HSC')) return 'Health Security Council (HSC)';
  if (u.startsWith('ADHOC')) return 'Ad Hoc Committee';
  if (u.startsWith('CRISIS')) return 'Crisis Committee';
  if (u.startsWith('UNOOSA')) return 'UN Office for Outer Space Affairs (UNOOSA)';
  if (u.startsWith('UNICEF')) return 'United Nations Children\'s Fund (UNICEF)';
  if (u.startsWith('WHO')) return 'World Health Organization (WHO)';
  // Branded accounts default to last known or GA
  if (['SENTIACHAIR','FUTURECHAIR','UNITYCHAIR','CHAIRLINK'].includes(u)) {
    return localStorage.getItem('chairlinkCommitteeName') || 'General Assembly';
  }
  return localStorage.getItem('chairlinkCommitteeName') || 'General Assembly';
}

// Removed duplicate function - using the main one defined earlier

function checkLoginState() {
  const user = localStorage.getItem('chairlinkUser');
  if (user) {
    document.getElementById('loginOverlay').style.display = 'none';
    document.body.classList.remove('overflow-hidden');
    document.getElementById('mainApp').style.display = '';
    document.getElementById('themeSelectorBar').style.display = '';
    loadData();
    setAvailableThemes(JSON.parse(user).username);
  } else {
    document.getElementById('loginOverlay').style.display = 'flex';
    document.body.classList.add('overflow-hidden');
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('themeSelectorBar').style.display = 'none';
  }
}

function logout() {
  localStorage.removeItem('chairlinkUser');
  location.reload();
}

document.getElementById('loginForm').onsubmit = function(e) {
  e.preventDefault();
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  const found = allowedUsers.find(u => u.username === username && u.password === password);
  if (found) {
    localStorage.setItem('chairlinkUser', JSON.stringify({ username }));
    // Set committee name based on the logged-in user
    const fullName = getFullCommitteeName(username);
    localStorage.setItem('chairlinkCommitteeName', fullName);
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('loadingOverlay').style.display = 'flex';
    setTimeout(() => {
      document.getElementById('loadingOverlay').style.display = 'none';
      document.body.classList.remove('overflow-hidden');
      document.getElementById('mainApp').style.display = '';
      loadData();
      document.getElementById('themeSelectorBar').style.display = '';
      setAvailableThemes(username);
      document.getElementById('loginError').classList.add('hidden');
      // Reflect the committee name in the header
      const committeeNameEl = document.getElementById('committeeName');
      if (committeeNameEl) committeeNameEl.textContent = localStorage.getItem('chairlinkCommitteeName') || fullName;
    }, 3140);
  } else {
    document.getElementById('loginError').textContent = "Incorrect username or password.";
    document.getElementById('loginError').classList.remove('hidden');
  }
};

function setAvailableThemes(username) {
  const themeSelector = document.getElementById('themeSelector');
  themeSelector.innerHTML = `
    <option value="light">Light</option>
    <option value="dark">Dark</option>
  `;
  // Remove Sentia themes entirely
  if (username === "FutureChair") {
    themeSelector.innerHTML += `
      <option value="future-light">Future Light</option>
      <option value="future-dark">Future Dark</option>
    `;
  }
  if (username === "UnityChair") {
    themeSelector.innerHTML += `
      <option value="unity-light">Unity Light</option>
      <option value="unity-dark">Unity Dark</option>
    `;
  }
  loadTheme();
}

function loadTheme() {
  let savedTheme = localStorage.getItem('chairlinkTheme') || 'light';
  if (savedTheme.startsWith('sentia-')) {
    savedTheme = 'light';
    localStorage.setItem('chairlinkTheme', savedTheme);
  }
  document.body.className = `font-sans theme-${savedTheme}`;
  const selector = document.getElementById('themeSelector');
  if (selector) selector.value = savedTheme;
}

document.getElementById('themeSelector').addEventListener('change', (e) => {
  const selectedTheme = e.target.value;
  // Guard: ignore Sentia themes if somehow present
  if (selectedTheme && !selectedTheme.startsWith('sentia-')) {
    localStorage.setItem('chairlinkTheme', selectedTheme);
  }
  loadTheme();
});

window.addEventListener('DOMContentLoaded', checkLoginState);

// PDF Import Delegates Functionality
let extractedDelegates = [];

// List of common country names for detection
const countryNames = [
    'Afghanistan', 'Albania', 'Algeria', 'Argentina', 'Armenia', 'Australia', 'Austria', 'Azerbaijan',
    'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan',
    'Bolivia', 'Bosnia', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi',
    'Cambodia', 'Cameroon', 'Canada', 'Cape Verde', 'Central African Republic', 'Chad', 'Chile', 'China',
    'Colombia', 'Comoros', 'Congo', 'Costa Rica', 'Croatia', 'Cuba', 'Cyprus', 'Czech Republic',
    'Denmark', 'Djibouti', 'Dominica', 'Dominican Republic', 'Ecuador', 'Egypt', 'El Salvador',
    'Equatorial Guinea', 'Eritrea', 'Estonia', 'Ethiopia', 'Fiji', 'Finland', 'France', 'Gabon',
    'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea', 'Guinea-Bissau',
    'Guyana', 'Haiti', 'Honduras', 'Hungary', 'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland',
    'Italy', 'Jamaica', 'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kiribati', 'Kuwait',
    'Kyrgyzstan', 'Laos', 'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Liechtenstein',
    'Lithuania', 'Luxembourg', 'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta',
    'Marshall Islands', 'Mauritania', 'Mauritius', 'Mexico', 'Micronesia', 'Moldova', 'Monaco',
    'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar', 'Namibia', 'Nauru', 'Nepal',
    'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Korea', 'North Macedonia',
    'Norway', 'Oman', 'Pakistan', 'Palau', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay',
    'Peru', 'Philippines', 'Poland', 'Portugal', 'Qatar', 'Romania', 'Russia', 'Rwanda',
    'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 'San Marino',
    'Sao Tome and Principe', 'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone',
    'Singapore', 'Slovakia', 'Slovenia', 'Solomon Islands', 'Somalia', 'South Africa', 'South Korea',
    'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria',
    'Tajikistan', 'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Tonga', 'Trinidad and Tobago',
    'Tunisia', 'Turkey', 'Turkmenistan', 'Tuvalu', 'Uganda', 'Ukraine', 'United Arab Emirates',
    'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan', 'Vanuatu', 'Vatican City',
    'Venezuela', 'Vietnam', 'Yemen', 'Zambia', 'Zimbabwe'
];

// Common court/crisis committee roles
const courtRoles = [
    'Judge', 'Prosecutor', 'Defense Attorney', 'Jury Member', 'Witness', 'Court Clerk',
    'Bailiff', 'Court Reporter', 'Expert Witness', 'Plaintiff', 'Defendant', 'Appellant',
    'Respondent', 'Petitioner', 'Respondent', 'Amicus Curiae', 'Court Administrator'
];

const crisisRoles = [
    'President', 'Prime Minister', 'Minister', 'Secretary', 'Director', 'Commander',
    'General', 'Admiral', 'Ambassador', 'Consul', 'Governor', 'Mayor', 'CEO',
    'Chairman', 'Chief', 'Leader', 'Representative', 'Spokesperson', 'Press Secretary'
];

function showImportDelegatesModal() {
    showModal('importDelegatesModal');
    resetImportModal();
}

function resetImportModal() {
    // Hide all sections
    document.getElementById('fileInfo').classList.add('hidden');
    document.getElementById('processingSection').classList.add('hidden');
    document.getElementById('resultsSection').classList.add('hidden');
    document.getElementById('errorSection').classList.add('hidden');
    
    // Reset file input
    document.getElementById('pdfFileInput').value = '';
    extractedDelegates = [];
}

// Initialize PDF.js
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

document.getElementById('pdfFileInput').addEventListener('change', handlePDFUpload);

async function handlePDFUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (file.type !== 'application/pdf') {
        showError('Please select a valid PDF file.');
        return;
    }
    
    // Show file info
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
    document.getElementById('fileInfo').classList.remove('hidden');
    
    // Start processing
    document.getElementById('processingSection').classList.remove('hidden');
    updateProcessingStatus('Extracting text from PDF...', 20);
    
    try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        
        updateProcessingStatus('Processing pages...', 40);
        
        let fullText = '';
        const totalPages = pdf.numPages;
        
        for (let i = 1; i <= totalPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n';
            
            const progress = 40 + (i / totalPages) * 40;
            updateProcessingStatus(`Processing page ${i} of ${totalPages}...`, progress);
        }
        
        updateProcessingStatus('Parsing delegate information...', 80);
        
        // Parse the text for delegates
        const delegates = parseDelegateText(fullText);
        
        updateProcessingStatus('Complete!', 100);
        
        setTimeout(() => {
            document.getElementById('processingSection').classList.add('hidden');
            showResults(delegates);
        }, 500);
        
    } catch (error) {
        console.error('Error processing PDF:', error);
        showError('Error processing PDF. Please make sure the file is not corrupted.');
    }
}

function parseDelegateText(text) {
    const delegates = [];
    
    console.log('Raw text from PDF:', text.substring(0, 500));
    
    // Handle the case where all text is in one line (like your PDF)
    let processedText = text.trim();
    
    // If it's all one line, try to parse it as a mixed list
    if (processedText.split('\n').length === 1) {
        console.log('Detected single line format - parsing mixed list');
        
        // Split by multiple spaces to get individual words/phrases
        const words = processedText.split(/\s{2,}/).filter(word => word.trim().length > 0);
        console.log('Words found:', words);
        
        // Extract only countries/roles (ignore names)
        const countries = [];
        
        for (const word of words) {
            const cleanWord = word.trim();
            
            // Check if it's a country (exact match only)
            const isCountry = countryNames.some(country => {
                const countryLower = country.toLowerCase();
                const wordLower = cleanWord.toLowerCase();
                return wordLower === countryLower;
            });
            
            if (isCountry) {
                countries.push(cleanWord);
                console.log(`Found country: ${cleanWord}`);
            } else {
                // Skip everything that's not a country
                console.log(`Skipping non-country: ${cleanWord}`);
            }
        }
        
        console.log(`Total countries/roles found: ${countries.length}`);
        
        // Add each country as a delegate (using country name as delegate name)
        for (const country of countries) {
            delegates.push({
                name: country, // Use country name as delegate name
                delegation: country,
                type: 'country'
            });
            
            console.log(`✅ Added delegate: ${country} (country)`);
        }
        
    } else {
        // Original line-by-line processing for multi-line PDFs
        const lines = processedText.split(/\r?\n/)
            .map(line => line.trim())
            .filter(line => line.length > 0);
        
        console.log('Total lines found:', lines.length);
        console.log('First 10 lines:', lines.slice(0, 10));
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            console.log(`Processing line ${i + 1}: "${line}"`);
            
            // Skip obvious headers
            if (line.match(/^(GA|ECOSOC|SC|UN|COMMITTEE|DELEGATE|LIST|NAME|COUNTRY)/i) || 
                (line.match(/^[A-Z\s]+$/) && line.length > 15)) {
                console.log(`Skipping header: ${line}`);
                continue;
            }
            
            // Simple dash pattern - most common format
            const dashMatch = line.match(/^(.+?)\s*-\s*(.+)$/);
            if (dashMatch) {
                let part1 = dashMatch[1].trim();
                let part2 = dashMatch[2].trim();
                
                console.log(`Dash match found: "${part1}" - "${part2}"`);
                
                // Clean up the parts
                part1 = part1.replace(/\s+/g, ' ').trim();
                part2 = part2.replace(/\s+/g, ' ').trim();
                
                // Skip if too short or too long
                if (part1.length < 2 || part2.length < 2 || part1.length > 60 || part2.length > 60) {
                    console.log(`Skipping - parts too short/long: "${part1}" "${part2}"`);
                    continue;
                }
                
                // Skip if no letters
                if (!/[a-zA-Z]/.test(part1) || !/[a-zA-Z]/.test(part2)) {
                    console.log(`Skipping - no letters: "${part1}" "${part2}"`);
                    continue;
                }
                
                // Determine which is country and which is name
                let name, delegation;
                
                // Check if part1 is a country
                const part1IsCountry = countryNames.some(country => {
                    const countryLower = country.toLowerCase();
                    const part1Lower = part1.toLowerCase();
                    return part1Lower === countryLower || 
                           part1Lower.includes(countryLower) ||
                           countryLower.includes(part1Lower);
                });
                
                // Check if part2 is a country
                const part2IsCountry = countryNames.some(country => {
                    const countryLower = country.toLowerCase();
                    const part2Lower = part2.toLowerCase();
                    return part2Lower === countryLower || 
                           part2Lower.includes(countryLower) ||
                           countryLower.includes(part2Lower);
                });
                
                if (part1IsCountry && !part2IsCountry) {
                    // Country - Name format
                    delegation = part1;
                    name = part2;
                    console.log(`Format: Country-Name: ${delegation} - ${name}`);
                } else if (part2IsCountry && !part1IsCountry) {
                    // Name - Country format
                    name = part1;
                    delegation = part2;
                    console.log(`Format: Name-Country: ${name} - ${delegation}`);
                } else {
                    // Neither or both are countries, assume Name - Country
                    name = part1;
                    delegation = part2;
                    console.log(`Format: Assumed Name-Country: ${name} - ${delegation}`);
                }
                
                // Final validation
                if (name.length >= 2 && delegation.length >= 2) {
                    // Check if delegation is recognized
                    const isCountry = countryNames.some(country => {
                        const countryLower = country.toLowerCase();
                        const delegationLower = delegation.toLowerCase();
                        return delegationLower === countryLower || 
                               delegationLower.includes(countryLower) ||
                               countryLower.includes(delegationLower);
                    });
                    
                    const isCourtRole = courtRoles.some(role => {
                        const roleLower = role.toLowerCase();
                        const delegationLower = delegation.toLowerCase();
                        return delegationLower.includes(roleLower);
                    });
                    
                    const isCrisisRole = crisisRoles.some(role => {
                        const roleLower = role.toLowerCase();
                        const delegationLower = delegation.toLowerCase();
                        return delegationLower.includes(roleLower);
                    });
                    
                    const delegateType = isCountry ? 'country' : (isCourtRole ? 'court' : (isCrisisRole ? 'crisis' : 'custom'));
                    
                    delegates.push({
                        name: name,
                        delegation: delegation,
                        type: delegateType
                    });
                    
                    console.log(`✅ Added delegate: ${name} - ${delegation} (${delegateType})`);
                }
            }
        }
    }
    
    console.log(`Total delegates found: ${delegates.length}`);
    return delegates;
}

function updateProcessingStatus(message, progress) {
    document.getElementById('processingStatus').textContent = message;
    document.getElementById('processingProgress').style.width = `${progress}%`;
}

function showResults(delegates) {
    extractedDelegates = delegates;
    const preview = document.getElementById('delegatePreview');
    preview.innerHTML = '';
    
    if (delegates.length === 0) {
        preview.innerHTML = '<p class="text-gray-500 italic text-center">No delegates found in the PDF. Please check the format.</p>';
    } else {
        delegates.forEach((delegate, index) => {
            const typeIcon = delegate.type === 'country' ? 'fas fa-flag' : 
                           delegate.type === 'court' ? 'fas fa-gavel' : 
                           delegate.type === 'custom' ? 'fas fa-user' : 'fas fa-user-tie';
            const typeColor = delegate.type === 'country' ? 'text-blue-600' : 
                            delegate.type === 'court' ? 'text-purple-600' : 
                            delegate.type === 'custom' ? 'text-gray-600' : 'text-red-600';
            
            preview.innerHTML += `
                <div class="flex items-center justify-between p-2 bg-white rounded border">
                    <div class="flex items-center">
                        <i class="${typeIcon} ${typeColor} mr-2"></i>
                        <span class="font-medium">${delegate.delegation}</span>
                    </div>
                    <span class="text-xs px-2 py-1 rounded ${delegate.type === 'country' ? 'bg-blue-100 text-blue-800' : 
                        delegate.type === 'court' ? 'bg-purple-100 text-purple-800' : 
                        delegate.type === 'custom' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800'}">
                        ${delegate.type}
                    </span>
                </div>
            `;
        });
    }
    
    document.getElementById('delegateCount').textContent = delegates.length;
    document.getElementById('resultsSection').classList.remove('hidden');
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorSection').classList.remove('hidden');
    document.getElementById('processingSection').classList.add('hidden');
}

// Handle import confirmation
document.getElementById('confirmImportBtn').addEventListener('click', function() {
    if (extractedDelegates.length === 0) {
        showNotification('No delegates to import.', 'warning');
        return;
    }
    
    let importedCount = 0;
    
    extractedDelegates.forEach(delegate => {
        // Check if delegate already exists
        const existingDelegate = delegates.find(d => 
            d.name.toLowerCase() === delegate.name.toLowerCase() && 
            d.country.toLowerCase() === delegate.delegation.toLowerCase()
        );
        
        if (!existingDelegate) {
            // Create a custom delegate
            let flagUrl;
            if (delegate.type === 'country') {
                flagUrl = `https://flagcdn.com/w320/${getCountryCode(delegate.delegation)}.png`;
            } else if (delegate.type === 'custom') {
                // For custom delegates, try to find a country match first
                const countryMatch = countryNames.find(country => 
                    delegate.delegation.toLowerCase().includes(country.toLowerCase()) ||
                    country.toLowerCase().includes(delegate.delegation.toLowerCase())
                );
                if (countryMatch) {
                    flagUrl = `https://flagcdn.com/w320/${getCountryCode(countryMatch)}.png`;
                } else {
                    flagUrl = 'https://via.placeholder.com/32x32/cccccc/666666?text=?';
                }
            } else {
                flagUrl = 'https://via.placeholder.com/32x32/cccccc/666666?text=?';
            }
            
            addDelegate(delegate.name, delegate.delegation, flagUrl);
            importedCount++;
        }
    });
    
    if (importedCount > 0) {
        showNotification(`Successfully imported ${importedCount} delegates!`, 'success');
        saveData();
        closeModal('importDelegatesModal');
    } else {
        showNotification('All delegates already exist in the system.', 'warning');
    }
});

function getCountryCode(countryName) {
    // Simple mapping for common countries - you can expand this
    const countryCodes = {
        'United States': 'us',
        'United Kingdom': 'gb',
        'Canada': 'ca',
        'Australia': 'au',
        'Germany': 'de',
        'France': 'fr',
        'Italy': 'it',
        'Spain': 'es',
        'Netherlands': 'nl',
        'Poland': 'pl',
        'Russia': 'ru',
        'China': 'cn',
        'Japan': 'jp',
        'India': 'in',
        'Brazil': 'br',
        'Mexico': 'mx',
        'Argentina': 'ar',
        'South Africa': 'za',
        'Egypt': 'eg',
        'Nigeria': 'ng',
        'Kenya': 'ke',
        'Turkey': 'tr',
        'Saudi Arabia': 'sa',
        'Iran': 'ir',
        'South Korea': 'kr',
        'Thailand': 'th',
        'Vietnam': 'vn',
        'Indonesia': 'id',
        'Philippines': 'ph',
        'Malaysia': 'my',
        'Singapore': 'sg',
        'New Zealand': 'nz',
        'Colombia': 'co',
        'Ethiopia': 'et',
        'Syria': 'sy',
        'Lebanon': 'lb',
        'Iraq': 'iq',
        'Sudan': 'sd',
        'Bosnia': 'ba',
        'Palestine': 'ps'
    };
    
    return countryCodes[countryName] || 'un'; // Default to UN flag
}
</script>

<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>

<script>
     // Your web app's Firebase configuration
   const firebaseConfig = {
     apiKey: "AIzaSyBUQe0yIvOE2H-aegXa9FdPgPZ8h1VI9_4",
     authDomain: "chairlink-backend.firebaseapp.com",
     projectId: "chairlink-backend",
     storageBucket: "chairlink-backend.firebasestorage.app",
     messagingSenderId: "332882160250",
     appId: "1:332882160250:web:c77752e8a3873e7568e9c3"
   };


     const app = firebase.initializeApp(firebaseConfig);
     const db = firebase.firestore();
   </script>
</body>
</html>
